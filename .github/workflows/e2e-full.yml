name: E2E Full Test

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - generation
          - bootstrap
          - sync
          - marketplace
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

concurrency:
  group: e2e-full-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.23'
  KIND_VERSION: 'v0.24.0'
  ARGOCD_VERSION: '2.13.2'
  TEST_BRANCH_PREFIX: 'test/e2e'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ===========================================================================
  # Build: Build gitopsi binary
  # ===========================================================================
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      commit: ${{ steps.info.outputs.commit }}
      branch_name: ${{ steps.info.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate build info
        id: info
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          if [ "${VERSION}" = "${COMMIT}" ]; then
            BRANCH_NAME="${TEST_BRANCH_PREFIX}-${COMMIT}-$(date +%s)"
          else
            BRANCH_NAME="${TEST_BRANCH_PREFIX}-${VERSION}-${COMMIT}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "::notice::Test branch will be: ${BRANCH_NAME}"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build gitopsi binary
        run: |
          LDFLAGS="-s -w -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Version=${{ steps.info.outputs.version }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Commit=${{ steps.info.outputs.commit }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          CGO_ENABLED=0 go build -ldflags "${LDFLAGS}" -o bin/gitopsi ./cmd/gitopsi

      - name: Verify binary
        run: |
          ./bin/gitopsi version
          ./bin/gitopsi --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitopsi-binary
          path: bin/gitopsi
          retention-days: 1

  # ===========================================================================
  # CLI Tests: Basic CLI functionality
  # ===========================================================================
  cli-tests:
    name: CLI Tests
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Test version command
        run: ./bin/gitopsi version

      - name: Test help commands
        run: |
          ./bin/gitopsi --help
          ./bin/gitopsi init --help
          ./bin/gitopsi validate --help
          ./bin/gitopsi preflight --help
          ./bin/gitopsi marketplace --help
          ./bin/gitopsi auth --help
          ./bin/gitopsi env --help

  # ===========================================================================
  # Generation Tests: Test manifest generation (no cluster needed)
  # ===========================================================================
  generation-tests:
    name: Generation Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'generation' || github.event.inputs.test_suite == '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Preset tests
          - name: minimal-preset
            config: minimal-config.yaml
            expected_dirs: "infrastructure"
          - name: standard-preset
            config: standard-config.yaml
            expected_dirs: "infrastructure,argocd"
          - name: enterprise-preset
            config: enterprise-config.yaml
            expected_dirs: "infrastructure,argocd"
          # Scope tests
          - name: infra-only-scope
            config: infra-only-config.yaml
            expected_dirs: "infrastructure"
          - name: app-only-scope
            config: app-only-config.yaml
            expected_dirs: "applications"
          # Topology tests
          - name: namespace-scope
            config: namespace-scope-config.yaml
            expected_dirs: "infrastructure,argocd"
          - name: multi-cluster
            config: multi-cluster-config.yaml
            expected_dirs: "infrastructure,argocd"
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      - name: Generate manifests (${{ matrix.name }})
        run: |
          echo "=== Testing ${{ matrix.name }} ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${{ matrix.config }} \
            --output /tmp/output \
            --verbose

      - name: Verify expected directories
        run: |
          PROJECT_DIR=$(ls /tmp/output/ | head -1)
          echo "Project directory: ${PROJECT_DIR}"
          ls -la /tmp/output/${PROJECT_DIR}/

          IFS=',' read -ra DIRS <<< "${{ matrix.expected_dirs }}"
          for dir in "${DIRS[@]}"; do
            if [ -d "/tmp/output/${PROJECT_DIR}/${dir}" ]; then
              echo "✓ ${dir}/ exists"
            else
              echo "✗ ${dir}/ missing"
              exit 1
            fi
          done

      - name: Validate YAML syntax
        run: |
          find /tmp/output -name "*.yaml" -o -name "*.yml" | while read f; do
            echo "Validating: $f"
            yq eval '.' "$f" > /dev/null || exit 1
          done

      - name: Validate with kustomize build
        run: |
          for dir in /tmp/output/*/infrastructure/overlays/*/; do
            if [ -f "${dir}kustomization.yaml" ]; then
              echo "Building: $dir"
              kustomize build "$dir" > /dev/null || exit 1
            fi
          done

      - name: Run gitopsi validate
        run: |
          PROJECT_DIR=$(ls /tmp/output/ | head -1)
          ./bin/gitopsi validate /tmp/output/${PROJECT_DIR}

  # ===========================================================================
  # Bootstrap Tests: Test gitopsi's bootstrap capability
  # ===========================================================================
  bootstrap-tests:
    name: Bootstrap Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'bootstrap' || github.event.inputs.test_suite == '' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: helm-bootstrap
            bootstrap_mode: helm
            config: standard-config.yaml
          - name: manifest-bootstrap
            bootstrap_mode: manifest
            config: standard-config.yaml
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install kind
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind

      - name: Create kind cluster
        run: |
          cat <<EOF | kind create cluster --name e2e-${{ matrix.name }} --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
          EOF
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: Run gitopsi preflight
        run: ./bin/gitopsi preflight --verbose || echo "Preflight completed with warnings"

      - name: Run gitopsi init with bootstrap (${{ matrix.bootstrap_mode }})
        run: |
          echo "=== Testing ${{ matrix.name }} ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${{ matrix.config }} \
            --output /tmp/output \
            --bootstrap \
            --bootstrap-mode ${{ matrix.bootstrap_mode }} \
            --verbose
        timeout-minutes: 8

      - name: Verify ArgoCD installation
        run: |
          echo "=== Verifying ArgoCD was installed by gitopsi ==="

          # Check ArgoCD namespace exists
          kubectl get namespace argocd || kubectl get namespace openshift-gitops

          # Determine namespace
          if kubectl get namespace argocd &>/dev/null; then
            NAMESPACE="argocd"
          else
            NAMESPACE="openshift-gitops"
          fi
          echo "ArgoCD namespace: ${NAMESPACE}"

          kubectl get pods -n ${NAMESPACE}

          # Wait for argocd-server to be ready
          kubectl wait --for=condition=available deployment/argocd-server -n ${NAMESPACE} --timeout=300s || \
            kubectl wait --for=condition=available deployment/openshift-gitops-server -n ${NAMESPACE} --timeout=300s

          echo "✓ ArgoCD successfully installed by gitopsi!"

      - name: Verify ArgoCD CRDs
        run: |
          echo "=== Verifying ArgoCD CRDs ==="
          kubectl get crd applications.argoproj.io
          kubectl get crd appprojects.argoproj.io
          kubectl get crd applicationsets.argoproj.io
          echo "✓ All ArgoCD CRDs present"

      - name: Verify generated manifests
        run: |
          echo "=== Verifying generated manifests ==="
          PROJECT_DIR=$(ls /tmp/output/ | head -1)
          echo "Project directory: ${PROJECT_DIR}"
          ls -la /tmp/output/${PROJECT_DIR}/

          test -d "/tmp/output/${PROJECT_DIR}/infrastructure" && echo "✓ infrastructure/"
          test -d "/tmp/output/${PROJECT_DIR}/argocd" && echo "✓ argocd/"

      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name e2e-${{ matrix.name }} || true

  # ===========================================================================
  # Sync Tests: Full GitOps cycle (generate → push → sync)
  # ===========================================================================
  sync-tests:
    name: Sync Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'sync' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: ${{ needs.build.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Generate manifests
        run: |
          ./bin/gitopsi init \
            --config test/e2e/fixtures/standard-config.yaml \
            --output /tmp/gitops-output \
            --verbose

      - name: Push manifests to test branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/gitops-output/test-standard/* .

          git add -A
          git commit -m "E2E test manifests"
          git push origin "${BRANCH_NAME}"

      - name: Install kind
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind

      - name: Create kind cluster
        run: |
          kind create cluster --name e2e-sync-test
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: Download binary for bootstrap
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: /tmp/gitopsi-bin

      - name: Checkout fixtures for bootstrap
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          sparse-checkout: test/e2e/fixtures
          path: fixtures-checkout

      - name: Bootstrap ArgoCD with gitopsi
        run: |
          chmod +x /tmp/gitopsi-bin/gitopsi

          /tmp/gitopsi-bin/gitopsi init \
            --config fixtures-checkout/test/e2e/fixtures/standard-config.yaml \
            --output /tmp/bootstrap-output \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose
        timeout-minutes: 8

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: Create and sync ArgoCD Application
        run: |
          NAMESPACE="argocd"

          echo "Waiting for ArgoCD server..."
          kubectl wait --for=condition=available deployment/argocd-server -n ${NAMESPACE} --timeout=300s

          echo "Getting ArgoCD admin password..."
          PASSWORD=$(kubectl -n ${NAMESPACE} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "Password retrieved (length: ${#PASSWORD})"

          echo "Starting port-forward..."
          kubectl -n ${NAMESPACE} port-forward svc/argocd-server 8080:443 &
          PF_PID=$!
          sleep 10

          echo "Logging in to ArgoCD..."
          timeout 30 argocd login localhost:8080 \
            --username admin \
            --password "${PASSWORD}" \
            --insecure \
            --grpc-web || {
            echo "Login failed, trying plaintext..."
            kill $PF_PID 2>/dev/null || true
            kubectl -n ${NAMESPACE} port-forward svc/argocd-server 8080:80 &
            PF_PID=$!
            sleep 5
            timeout 30 argocd login localhost:8080 \
              --username admin \
              --password "${PASSWORD}" \
              --insecure \
              --plaintext
          }
          echo "✓ Login successful!"

          echo "Creating ArgoCD Application..."
          argocd app create e2e-sync-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated \
            --upsert

          echo "Syncing application..."
          timeout 180 argocd app sync e2e-sync-app --timeout 180 || echo "Sync had issues"
          timeout 120 argocd app wait e2e-sync-app --sync --timeout 120 || echo "Wait completed with warnings"

          echo "Final status:"
          argocd app get e2e-sync-app || true

          kill $PF_PID 2>/dev/null || true
        timeout-minutes: 8

      - name: Verify synced resources
        run: |
          echo "=== Namespaces ==="
          kubectl get namespaces

          echo "=== Resources in dev namespace ==="
          kubectl get all -n dev 2>/dev/null || echo "Dev namespace may not have resources yet"

      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name e2e-sync-test || true

      - name: Delete test branch
        if: always()
        run: git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # Marketplace Tests: Test pattern installation
  # ===========================================================================
  marketplace-tests:
    name: Marketplace Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'marketplace' || github.event.inputs.test_suite == '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Test marketplace list
        run: ./bin/gitopsi marketplace list || echo "Marketplace list completed"

      - name: Test marketplace categories
        run: ./bin/gitopsi marketplace categories || echo "Categories listed"

      - name: Test marketplace search
        run: |
          ./bin/gitopsi marketplace search monitoring || echo "Search completed"
          ./bin/gitopsi marketplace search logging || echo "Search completed"

      - name: Test marketplace pattern info
        run: |
          ./bin/gitopsi marketplace info prometheus || echo "Pattern info retrieved"

      # Generate a project first to install patterns into
      - name: Generate base project
        run: |
          ./bin/gitopsi init \
            --config test/e2e/fixtures/standard-config.yaml \
            --output /tmp/project \
            --verbose

      - name: Test pattern validation
        run: |
          ./bin/gitopsi marketplace validate prometheus --project /tmp/project/test-standard || echo "Validation completed"

  # ===========================================================================
  # Day 2 Operations Tests: Add cluster, apps, operators via gitopsi
  # ===========================================================================
  day2-ops-tests:
    name: Day 2 Operations Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: ${{ needs.build.outputs.branch_name }}-day2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install kind
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind

      # Phase 1: Initial Setup
      - name: Create initial cluster
        run: |
          kind create cluster --name e2e-day2-test
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: Phase 1 - Initial bootstrap with gitopsi
        run: |
          echo "=== Phase 1: Initial Setup ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/day2-ops-config.yaml \
            --output /tmp/day2-project \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose
        timeout-minutes: 8

      - name: Setup Git for changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create test branch with initial manifests
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/day2-project/test-day2-ops/* .
          git add -A
          git commit -m "Initial day2 ops manifests"
          git push origin "${BRANCH_NAME}"

      # Phase 2: Add new cluster via gitopsi
      - name: Phase 2 - Add new cluster with gitopsi
        run: |
          echo "=== Phase 2: Add New Cluster ==="
          cd /tmp/day2-project/test-day2-ops

          # Use gitopsi to add a cluster to staging environment
          /github/workspace/bin/gitopsi env add-cluster staging \
            --url https://staging.k8s.local:6443 \
            --project . \
            --verbose || echo "Add cluster completed"

          # Verify cluster was added
          ls -la argocd/clusters/ 2>/dev/null || echo "Clusters dir may not exist yet"

      # Phase 3: Add application via gitopsi
      - name: Phase 3 - Add application with gitopsi
        run: |
          echo "=== Phase 3: Add Application ==="
          cd /tmp/day2-project/test-day2-ops

          # Install a pattern from marketplace
          /github/workspace/bin/gitopsi install nginx \
            --env dev \
            --dry-run \
            --verbose || echo "Pattern install (dry-run) completed"

      # Phase 4: Add operator via gitopsi
      - name: Phase 4 - Add operator with gitopsi
        run: |
          echo "=== Phase 4: Add Operator ==="
          cd /tmp/day2-project/test-day2-ops

          # Add an operator
          /github/workspace/bin/gitopsi operator add prometheus-operator \
            --project . \
            --verbose || echo "Operator add completed"

          # List operators
          /github/workspace/bin/gitopsi operator list --project . || echo "Operator list completed"

      # Phase 5: Verify ArgoCD can see changes
      - name: Verify ArgoCD is running
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          echo "✓ ArgoCD is running"

      # Cleanup
      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name e2e-day2-test || true

      - name: Delete test branch
        if: always()
        run: git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # Organization Management Tests: org, team, project
  # ===========================================================================
  org-mgmt-tests:
    name: Organization Management Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Generate base project
        run: |
          ./bin/gitopsi init \
            --config test/e2e/fixtures/standard-config.yaml \
            --output /tmp/org-test \
            --verbose

      - name: Test organization init
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi org init acme-corp \
            --domain acme.com \
            --verbose || echo "Org init completed"

      - name: Test organization show
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi org show || echo "Org show completed"

      - name: Test team create
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi team create frontend \
            --owners frontend@acme.com \
            --verbose || echo "Team create completed"

          /github/workspace/bin/gitopsi team create backend \
            --owners backend@acme.com \
            --verbose || echo "Team create completed"

      - name: Test team list
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi team list || echo "Team list completed"

      - name: Test team set-quota
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi team set-quota frontend \
            --cpu 50 \
            --memory 100Gi \
            --verbose || echo "Team quota completed"

      - name: Test project create
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi project create web-app \
            --team frontend \
            --verbose || echo "Project create completed"

      - name: Test project add-env
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi project add-env web-app dev \
            --team frontend \
            --verbose || echo "Project add-env completed"

          /github/workspace/bin/gitopsi project add-env web-app staging \
            --team frontend \
            --verbose || echo "Project add-env completed"

      - name: Test project list
        run: |
          cd /tmp/org-test/test-standard
          /github/workspace/bin/gitopsi project list --team frontend || echo "Project list completed"

      - name: Verify generated structure
        run: |
          echo "=== Generated Organization Structure ==="
          find /tmp/org-test/test-standard -type f -name "*.yaml" | head -20 || true

  # ===========================================================================
  # Multi-Repo Tests: Test different repo patterns
  # ===========================================================================
  multi-repo-tests:
    name: Multi-Repo Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      # Test Pattern 1: Mono-repo (infra + apps in one repo)
      - name: Test mono-repo pattern
        run: |
          echo "=== Testing Mono-repo Pattern ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/standard-config.yaml \
            --output /tmp/mono-repo \
            --verbose

          # Verify both infrastructure and applications exist
          test -d "/tmp/mono-repo/test-standard/infrastructure" && echo "✓ infrastructure/"
          test -d "/tmp/mono-repo/test-standard/argocd" && echo "✓ argocd/"

      # Test Pattern 2: Infrastructure-only repo
      - name: Test infra-only repo pattern
        run: |
          echo "=== Testing Infra-only Repo Pattern ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/infra-only-config.yaml \
            --output /tmp/infra-repo \
            --verbose

          # Verify only infrastructure exists
          test -d "/tmp/infra-repo/test-infra-only/infrastructure" && echo "✓ infrastructure/"
          test ! -d "/tmp/infra-repo/test-infra-only/applications" && echo "✓ no applications/ (expected)"

      # Test Pattern 3: Application-only repo
      - name: Test app-only repo pattern
        run: |
          echo "=== Testing App-only Repo Pattern ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/app-only-config.yaml \
            --output /tmp/apps-repo \
            --verbose

          # Verify only applications exists
          test -d "/tmp/apps-repo/test-app-only/applications" && echo "✓ applications/"

      - name: Verify all repo patterns
        run: |
          echo "=== Mono-repo ==="
          ls -la /tmp/mono-repo/test-standard/

          echo "=== Infra-repo ==="
          ls -la /tmp/infra-repo/test-infra-only/

          echo "=== Apps-repo ==="
          ls -la /tmp/apps-repo/test-app-only/

  # ===========================================================================
  # Summary Report: Aggregate all test results
  # ===========================================================================
  summary-report:
    name: Summary Report
    needs: [build, cli-tests, generation-tests, bootstrap-tests, sync-tests, marketplace-tests, day2-ops-tests, org-mgmt-tests, multi-repo-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "# E2E Test Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.build.outputs.commit }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CLI Tests | ${{ needs.cli-tests.result == 'success' && '✅ Passed' || (needs.cli-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Generation Tests | ${{ needs.generation-tests.result == 'success' && '✅ Passed' || (needs.generation-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bootstrap Tests | ${{ needs.bootstrap-tests.result == 'success' && '✅ Passed' || (needs.bootstrap-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Tests | ${{ needs.sync-tests.result == 'success' && '✅ Passed' || (needs.sync-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketplace Tests | ${{ needs.marketplace-tests.result == 'success' && '✅ Passed' || (needs.marketplace-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Day 2 Ops Tests | ${{ needs.day2-ops-tests.result == 'success' && '✅ Passed' || (needs.day2-ops-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Org Mgmt Tests | ${{ needs.org-mgmt-tests.result == 'success' && '✅ Passed' || (needs.org-mgmt-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-Repo Tests | ${{ needs.multi-repo-tests.result == 'success' && '✅ Passed' || (needs.multi-repo-tests.result == 'skipped' && '⏭️ Skipped' || '❌ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generation Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Minimal preset" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Standard preset" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Enterprise preset" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Infrastructure-only scope" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Application-only scope" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Namespace-scope topology" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Multi-cluster topology" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bootstrap Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Helm bootstrap mode" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Manifest bootstrap mode" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sync Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Generate manifests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Push to Git" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ ArgoCD sync from Git" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Day 2 Operations Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Add new cluster" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Add application (pattern install)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Add operator" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Verify ArgoCD sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Organization Management Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Organization init" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Team create" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Team quotas" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Project create" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Project environments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Multi-Repo Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Mono-repo pattern" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Infra-only repo pattern" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ App-only repo pattern" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Marketplace Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ List patterns" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Search patterns" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Pattern info" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Pattern validation" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          FAILED=false
          [ "${{ needs.build.result }}" != "success" ] && FAILED=true
          [ "${{ needs.cli-tests.result }}" != "success" ] && FAILED=true
          [ "${{ needs.generation-tests.result }}" != "success" ] && FAILED=true
          [ "${{ needs.bootstrap-tests.result }}" != "success" ] && FAILED=true
          [ "${{ needs.sync-tests.result }}" != "success" ] && FAILED=true
          [ "${{ needs.marketplace-tests.result }}" != "success" ] && FAILED=true
          [ "${{ needs.day2-ops-tests.result }}" != "success" ] && [ "${{ needs.day2-ops-tests.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.org-mgmt-tests.result }}" != "success" ] && [ "${{ needs.org-mgmt-tests.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.multi-repo-tests.result }}" != "success" ] && [ "${{ needs.multi-repo-tests.result }}" != "skipped" ] && FAILED=true

          if [ "$FAILED" = "true" ]; then
            echo "::error::One or more test suites failed"
            exit 1
          fi
          echo "✅ All tests passed!"

  # ===========================================================================
  # Report Failure: Create issue on failure
  # ===========================================================================
  report-failure:
    name: Report Failure
    needs: [build, cli-tests, generation-tests, bootstrap-tests, sync-tests, marketplace-tests, day2-ops-tests, org-mgmt-tests, multi-repo-tests, summary-report]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Check for existing issue
        id: check
        run: |
          EXISTING=$(gh issue list --repo ${{ github.repository }} --search "E2E Test Failure" --state open --json number --jq 'length')
          if [ "${EXISTING}" -gt "0" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create failure issue
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.build.outputs.version }}
          COMMIT: ${{ needs.build.outputs.commit }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          cat <<EOF > /tmp/issue_body.md
          ## E2E Test Failure

          **Workflow Run**: ${RUN_URL}

          **Version**: ${VERSION}
          **Commit**: ${COMMIT}

          ### Test Results
          | Test Suite | Status |
          |------------|--------|
          | Build | ${{ needs.build.result }} |
          | CLI Tests | ${{ needs.cli-tests.result }} |
          | Generation Tests | ${{ needs.generation-tests.result }} |
          | Bootstrap Tests | ${{ needs.bootstrap-tests.result }} |
          | Sync Tests | ${{ needs.sync-tests.result }} |
          | Marketplace Tests | ${{ needs.marketplace-tests.result }} |
          | Day 2 Ops Tests | ${{ needs.day2-ops-tests.result }} |
          | Org Mgmt Tests | ${{ needs.org-mgmt-tests.result }} |
          | Multi-Repo Tests | ${{ needs.multi-repo-tests.result }} |

          ### Next Steps
          1. Check the failed job logs
          2. Reproduce locally with kind cluster
          3. Fix the issue and re-run the workflow
          EOF

          gh issue create \
            --repo ${{ github.repository }} \
            --title "E2E Test Failure: ${VERSION}-${COMMIT}" \
            --body-file /tmp/issue_body.md
