name: E2E Full Test

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      preset:
        description: 'Preset to test (minimal, standard, enterprise)'
        required: false
        default: 'standard'
        type: choice
        options:
          - minimal
          - standard
          - enterprise
      bootstrap_mode:
        description: 'Bootstrap mode to test'
        required: false
        default: 'helm'
        type: choice
        options:
          - helm
          - manifest
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

concurrency:
  group: e2e-full-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.23'
  KIND_VERSION: 'v0.24.0'
  ARGOCD_VERSION: '2.13.2'
  TEST_BRANCH_PREFIX: 'test/e2e'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ===========================================================================
  # Build: Build gitopsi binary
  # ===========================================================================
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      commit: ${{ steps.info.outputs.commit }}
      branch_name: ${{ steps.info.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate build info
        id: info
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          # Avoid duplicate if version equals commit
          if [ "${VERSION}" = "${COMMIT}" ]; then
            BRANCH_NAME="${TEST_BRANCH_PREFIX}-${COMMIT}-$(date +%s)"
          else
            BRANCH_NAME="${TEST_BRANCH_PREFIX}-${VERSION}-${COMMIT}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "::notice::Test branch will be: ${BRANCH_NAME}"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build gitopsi binary
        run: |
          LDFLAGS="-s -w -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Version=${{ steps.info.outputs.version }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Commit=${{ steps.info.outputs.commit }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          CGO_ENABLED=0 go build -ldflags "${LDFLAGS}" -o bin/gitopsi ./cmd/gitopsi

      - name: Verify binary
        run: |
          ./bin/gitopsi version
          ./bin/gitopsi --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitopsi-binary
          path: bin/gitopsi
          retention-days: 1

  # ===========================================================================
  # CLI Testing: Test CLI commands (no cluster needed)
  # ===========================================================================
  cli-test:
    name: CLI Command Testing
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Test version command
        run: ./bin/gitopsi version

      - name: Test help commands
        run: |
          ./bin/gitopsi --help
          ./bin/gitopsi init --help
          ./bin/gitopsi validate --help
          ./bin/gitopsi preflight --help

      - name: Test init with dry-run
        run: |
          ./bin/gitopsi init \
            --config test/e2e/fixtures/minimal-config.yaml \
            --output /tmp/test-output \
            --dry-run \
            --verbose

      - name: Test init and validate
        run: |
          ./bin/gitopsi init \
            --config test/e2e/fixtures/standard-config.yaml \
            --output /tmp/test-output \
            --verbose
          ./bin/gitopsi validate /tmp/test-output/test-standard

  # ===========================================================================
  # E2E Bootstrap Test: Test gitopsi's bootstrap capability
  # This is the REAL E2E test - gitopsi installs ArgoCD, not manual helm
  # ===========================================================================
  e2e-bootstrap:
    name: E2E Bootstrap Test (${{ github.event.inputs.bootstrap_mode || 'helm' }})
    needs: [build]
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ needs.build.outputs.branch_name }}
      BOOTSTRAP_MODE: ${{ github.event.inputs.bootstrap_mode || 'helm' }}
      PRESET: ${{ github.event.inputs.preset || 'standard' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      # --- Kind Cluster Setup ---
      - name: Install kind
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind
          kind version

      - name: Create kind cluster
        run: |
          cat <<EOF | kind create cluster --name e2e-test --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
            - role: control-plane
          EOF
        timeout-minutes: 3

      - name: Verify cluster
        run: |
          kubectl cluster-info
          kubectl get nodes
          kubectl wait --for=condition=Ready nodes --all --timeout=120s

      # --- Test gitopsi preflight ---
      - name: Run gitopsi preflight
        run: |
          echo "=== Testing gitopsi preflight command ==="
          ./bin/gitopsi preflight --verbose || echo "Preflight completed with warnings (expected on fresh cluster)"

      # --- Test gitopsi init with --bootstrap ---
      # THIS IS THE REAL TEST: gitopsi should install ArgoCD
      - name: Run gitopsi init with bootstrap
        run: |
          echo "=== Testing gitopsi init --bootstrap ==="
          echo "Bootstrap mode: ${BOOTSTRAP_MODE}"
          echo "Preset: ${PRESET}"

          # Run gitopsi init with bootstrap flag
          # This tests gitopsi's ability to:
          # 1. Generate manifests
          # 2. Install ArgoCD on the cluster
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${PRESET}-config.yaml \
            --output /tmp/gitops-output \
            --bootstrap \
            --bootstrap-mode ${BOOTSTRAP_MODE} \
            --verbose
        timeout-minutes: 8

      # --- Verify ArgoCD was installed by gitopsi ---
      - name: Verify ArgoCD installation
        run: |
          echo "=== Verifying ArgoCD was installed by gitopsi ==="

          # Check ArgoCD namespace exists
          kubectl get namespace argocd || kubectl get namespace openshift-gitops

          # Determine ArgoCD namespace
          if kubectl get namespace argocd &>/dev/null; then
            NAMESPACE="argocd"
          else
            NAMESPACE="openshift-gitops"
          fi
          echo "ArgoCD namespace: ${NAMESPACE}"

          kubectl get pods -n ${NAMESPACE}

          # Wait for argocd-server to be ready
          kubectl wait --for=condition=available deployment/argocd-server -n ${NAMESPACE} --timeout=300s || \
            kubectl wait --for=condition=available deployment/openshift-gitops-server -n ${NAMESPACE} --timeout=300s

          echo "ArgoCD successfully installed by gitopsi!"

      # --- Verify ArgoCD CRDs exist ---
      - name: Verify ArgoCD CRDs
        run: |
          echo "=== Verifying ArgoCD CRDs ==="
          kubectl get crd applications.argoproj.io
          kubectl get crd appprojects.argoproj.io
          kubectl get crd applicationsets.argoproj.io

      # --- Verify generated manifests ---
      - name: Verify generated manifests
        run: |
          echo "=== Verifying generated manifests ==="
          ls -la /tmp/gitops-output/

          # Check expected directories exist
          PROJECT_DIR=$(ls /tmp/gitops-output/ | head -1)
          echo "Project directory: ${PROJECT_DIR}"

          ls -la /tmp/gitops-output/${PROJECT_DIR}/

          # Verify key directories
          test -d "/tmp/gitops-output/${PROJECT_DIR}/infrastructure" && echo "✓ infrastructure/"
          test -d "/tmp/gitops-output/${PROJECT_DIR}/argocd" && echo "✓ argocd/"

      # --- Test ArgoCD CLI access (optional) ---
      - name: Install ArgoCD CLI and verify access
        run: |
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

          NAMESPACE=$(kubectl get namespace argocd -o name 2>/dev/null && echo "argocd" || echo "openshift-gitops")

          # Get admin password
          PASSWORD=$(kubectl -n ${NAMESPACE} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo "")

          if [ -n "${PASSWORD}" ]; then
            echo "ArgoCD admin password retrieved successfully"

            # Port-forward and login
            kubectl -n ${NAMESPACE} port-forward svc/argocd-server 8080:80 &
            sleep 5

            argocd login localhost:8080 \
              --username admin \
              --password "${PASSWORD}" \
              --insecure \
              --plaintext

            argocd app list
            echo "ArgoCD CLI access verified!"
          else
            echo "No initial admin secret found (may be expected for some configurations)"
          fi

      # --- Cleanup ---
      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name e2e-test || true

  # ===========================================================================
  # E2E Git Sync Test: Full GitOps cycle test
  # ===========================================================================
  e2e-git-sync:
    name: E2E Git Sync Test
    needs: [build]
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ needs.build.outputs.branch_name }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      # --- Generate and push manifests ---
      - name: Generate manifests
        run: |
          ./bin/gitopsi init \
            --config test/e2e/fixtures/standard-config.yaml \
            --output /tmp/gitops-output \
            --verbose

      - name: Push manifests to test branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create orphan branch
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          # Copy manifests
          cp -r /tmp/gitops-output/test-standard/* .

          # Commit and push
          git add -A
          git commit -m "E2E test manifests"
          git push origin "${BRANCH_NAME}"

      # --- Kind cluster setup ---
      - name: Install kind
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind

      - name: Create kind cluster
        run: |
          kind create cluster --name e2e-sync-test
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      # --- Bootstrap with gitopsi ---
      - name: Download binary for bootstrap
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: /tmp/gitopsi-bin

      - name: Checkout fixtures for bootstrap
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          sparse-checkout: test/e2e/fixtures
          path: fixtures-checkout

      - name: Bootstrap ArgoCD with gitopsi
        run: |
          chmod +x /tmp/gitopsi-bin/gitopsi

          /tmp/gitopsi-bin/gitopsi init \
            --config fixtures-checkout/test/e2e/fixtures/standard-config.yaml \
            --output /tmp/bootstrap-output \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose
        timeout-minutes: 8

      # --- Create ArgoCD Application pointing to test branch ---
      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: Create and sync ArgoCD Application
        run: |
          NAMESPACE="argocd"

          # Wait for ArgoCD to be ready
          kubectl wait --for=condition=available deployment/argocd-server -n ${NAMESPACE} --timeout=300s

          # Get password and login
          PASSWORD=$(kubectl -n ${NAMESPACE} get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n ${NAMESPACE} port-forward svc/argocd-server 8080:80 &
          sleep 5

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --plaintext

          # Create application pointing to our test branch
          argocd app create e2e-sync-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated

          # Sync and verify
          argocd app sync e2e-sync-app --timeout 300 || true
          argocd app wait e2e-sync-app --sync --timeout 300 || echo "Sync completed with warnings"

          # Show status
          argocd app get e2e-sync-app
        timeout-minutes: 6

      - name: Verify synced resources
        run: |
          echo "=== Namespaces ==="
          kubectl get namespaces

          echo "=== Resources in dev namespace ==="
          kubectl get all -n dev 2>/dev/null || echo "Dev namespace may not have resources yet"

      # --- Cleanup ---
      - name: Delete kind cluster
        if: always()
        run: kind delete cluster --name e2e-sync-test || true

      - name: Delete test branch
        if: always()
        run: git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # Report Failure
  # ===========================================================================
  report-failure:
    name: Report Failure
    needs: [build, cli-test, e2e-bootstrap, e2e-git-sync]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Check for existing issue
        id: check
        run: |
          EXISTING=$(gh issue list --repo ${{ github.repository }} --search "E2E Test Failure" --state open --json number --jq 'length')
          if [ "${EXISTING}" -gt "0" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create failure issue
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.build.outputs.version }}
          COMMIT: ${{ needs.build.outputs.commit }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          cat <<EOF > /tmp/issue_body.md
          ## E2E Test Failure

          **Workflow Run**: ${RUN_URL}

          **Version**: ${VERSION}
          **Commit**: ${COMMIT}
          **Bootstrap Mode**: ${{ github.event.inputs.bootstrap_mode || 'helm' }}
          **Preset**: ${{ github.event.inputs.preset || 'standard' }}

          ### What was tested
          - gitopsi CLI commands
          - gitopsi init --bootstrap (ArgoCD installation)
          - GitOps sync cycle

          ### Next Steps
          1. Check the failed job logs
          2. Reproduce locally with kind cluster
          3. Fix the issue and re-run the workflow
          EOF

          gh issue create \
            --repo ${{ github.repository }} \
            --title "E2E Test Failure: ${VERSION}-${COMMIT}" \
            --body-file /tmp/issue_body.md
