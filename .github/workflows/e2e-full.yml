name: E2E Full Test

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - minimal
          - standard
          - enterprise
          - infra-only
          - app-only
          - namespace-scope
          - multi-cluster
          - marketplace
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

concurrency:
  group: e2e-full-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.23'
  KIND_VERSION: 'v0.24.0'
  ARGOCD_VERSION: '2.13.2'
  TEST_BRANCH_PREFIX: 'test/e2e'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ===========================================================================
  # Build: Build gitopsi binary
  # ===========================================================================
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      commit: ${{ steps.info.outputs.commit }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate build info
        id: info
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "::notice::Version: ${VERSION}, Commit: ${COMMIT}"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build gitopsi binary
        run: |
          LDFLAGS="-s -w -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Version=${{ steps.info.outputs.version }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Commit=${{ steps.info.outputs.commit }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          CGO_ENABLED=0 go build -ldflags "${LDFLAGS}" -o bin/gitopsi ./cmd/gitopsi

      - name: Verify binary
        run: |
          ./bin/gitopsi version
          ./bin/gitopsi --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitopsi-binary
          path: bin/gitopsi
          retention-days: 1

  # ===========================================================================
  # MINIMAL PRESET: Complete 12-step flow
  # ===========================================================================
  minimal-preset-flow:
    name: Minimal Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'minimal' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-minimal-${{ github.run_id }}
      PROJECT_NAME: test-minimal
      CONFIG_FILE: minimal-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          # Install kind
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind

          # Install ArgoCD CLI
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      # Step 1: Generate Manifests
      - name: "Step 1: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 1: Generate Manifests (Minimal Preset) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo "Generated structure:"
          find /tmp/output -type f -name "*.yaml" | head -20

      # Step 2: Create Kind Cluster
      - name: "Step 2: Create Kind Cluster"
        run: |
          echo "=== Step 2: Create Kind Cluster ==="
          kind create cluster --name e2e-minimal
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
        timeout-minutes: 3

      # Step 3: Push to Git
      - name: "Step 3: Push to Git"
        run: |
          echo "=== Step 3: Push to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E minimal preset manifests"
          git push origin "${BRANCH_NAME}"

          echo "Pushed to branch: ${BRANCH_NAME}"

      # Step 4: Bootstrap ArgoCD
      - name: "Step 4: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 4: Bootstrap ArgoCD ==="
          # Re-checkout to get fixtures
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose
        timeout-minutes: 8

      # Step 5: Configure ArgoCD to sync from Git
      - name: "Step 5: Configure ArgoCD to sync from Git"
        run: |
          echo "=== Step 5: Configure ArgoCD Application ==="

          # Wait for ArgoCD
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          # Get admin password
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)

          # Port forward
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          # Login
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          # Create Application pointing to test branch
          argocd app create e2e-minimal-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated \
            --upsert

          echo "ArgoCD Application created"

      # Step 6: Verify Initial Sync
      - name: "Step 6: Verify Initial Sync"
        run: |
          echo "=== Step 6: Verify Initial Sync ==="

          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-minimal-app --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          argocd app wait e2e-minimal-app --sync --timeout 120 || true

          # Check status
          STATUS=$(argocd app get e2e-minimal-app -o json | jq -r '.status.sync.status')
          echo "Sync Status: ${STATUS}"

          if [ "${STATUS}" != "Synced" ]; then
            echo "Warning: App not fully synced, but continuing..."
          fi

      # Step 7: Validate Initial Deployment on Cluster
      - name: "Step 7: Validate Initial Deployment on Cluster"
        run: |
          echo "=== Step 7: Validate Resources on Cluster ==="

          # For minimal preset, namespace is prefixed with project name
          NAMESPACE="${PROJECT_NAME}-dev"
          echo "Checking namespace: ${NAMESPACE}..."
          kubectl get namespace "${NAMESPACE}" || echo "Namespace not yet created"

          # Wait a bit for sync
          sleep 30

          # Verify namespace exists
          if kubectl get namespace "${NAMESPACE}" &>/dev/null; then
            echo "✓ Namespace '${NAMESPACE}' exists on cluster"
            kubectl get namespace "${NAMESPACE}" -o yaml | head -20
          else
            echo "Namespace ${NAMESPACE} not found, checking all namespaces..."
            kubectl get namespaces
          fi

          echo "Cluster resources:"
          kubectl get namespaces

      # Step 8: Make Code Changes
      - name: "Step 8: Make Code Changes"
        run: |
          echo "=== Step 8: Make Code Changes ==="

          # Add a test label to the namespace
          if [ -f "infrastructure/base/namespaces/dev.yaml" ]; then
            # Add label to namespace
            cat infrastructure/base/namespaces/dev.yaml

            # Use yq to add label
            yq eval '.metadata.labels["e2e-test-change"] = "true"' -i infrastructure/base/namespaces/dev.yaml

            echo "Modified namespace:"
            cat infrastructure/base/namespaces/dev.yaml
          else
            echo "Namespace file not found, checking structure..."
            find . -name "*.yaml" | head -10
          fi

      # Step 9: Push Changes to Git
      - name: "Step 9: Push Changes to Git"
        run: |
          echo "=== Step 9: Push Changes to Git ==="

          git add -A
          git diff --cached --stat

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "E2E test: Add label to namespace"
            git push origin "${BRANCH_NAME}"
            echo "Changes pushed"
          fi

      # Step 10: Verify ArgoCD Detects and Syncs Changes
      - name: "Step 10: Verify ArgoCD Syncs Changes"
        run: |
          echo "=== Step 10: Verify ArgoCD Syncs ==="

          # Trigger refresh
          argocd app get e2e-minimal-app --refresh || true

          # Wait for sync
          sleep 30

          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-minimal-app --timeout 120 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          # Check status
          argocd app get e2e-minimal-app

      # Step 11: Validate Changes Applied on Cluster
      - name: "Step 11: Validate Changes on Cluster"
        run: |
          echo "=== Step 11: Validate Changes on Cluster ==="

          # Check if the label was applied (namespace is prefixed with project name)
          NAMESPACE="${PROJECT_NAME}-dev"
          LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.e2e-test-change}' 2>/dev/null || echo "")

          if [ "${LABEL}" = "true" ]; then
            echo "✓ Label 'e2e-test-change=true' found on namespace ${NAMESPACE}"
          else
            echo "Label not found (may not have synced yet)"
            echo "Current namespace labels:"
            kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' || true
          fi

          echo ""
          echo "=== MINIMAL PRESET TEST COMPLETED ==="

      # Step 12: Cleanup
      - name: "Step 12: Cleanup"
        if: always()
        run: |
          echo "=== Step 12: Cleanup ==="
          kind delete cluster --name e2e-minimal || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # STANDARD PRESET: Complete 12-step flow
  # ===========================================================================
  standard-preset-flow:
    name: Standard Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'standard' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-standard-${{ github.run_id }}
      PROJECT_NAME: test-standard
      CONFIG_FILE: standard-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      - name: "Step 1: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 1: Generate Manifests (Standard Preset) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --git-url https://github.com/${{ github.repository }}.git --verbose
          find /tmp/output -type d | head -20

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-standard
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E standard preset manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --git-url https://github.com/${{ github.repository }}.git --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Step 5: Configure ArgoCD"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-standard-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

      - name: "Step 6: Verify Initial Sync"
        run: |
          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-standard-app --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          argocd app wait e2e-standard-app --sync --timeout 120 || true
          argocd app get e2e-standard-app

      - name: "Step 7: Validate Initial Deployment"
        run: |
          echo "=== Validating Standard Preset Resources ==="
          sleep 30

          # Namespace is prefixed with project name
          NAMESPACE="${PROJECT_NAME}-dev"
          echo "Checking namespace: ${NAMESPACE}..."
          kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || echo "Namespace not yet created"

          # RBAC (standard has RBAC)
          kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RoleBindings found" || echo "No RoleBindings yet"

          # NetworkPolicies
          kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies found" || echo "No NetworkPolicies yet"

          # ResourceQuotas
          kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas found" || echo "No ResourceQuotas yet"

          echo "All namespaces:"
          kubectl get namespaces

      - name: "Step 8: Make Code Changes"
        run: |
          # Modify resource quota limits
          if [ -f "infrastructure/base/resource-quotas/dev.yaml" ]; then
            yq eval '.spec.hard["limits.cpu"] = "20"' -i infrastructure/base/resource-quotas/dev.yaml
            echo "Modified resource quota"
            cat infrastructure/base/resource-quotas/dev.yaml
          else
            # Add label to namespace instead
            yq eval '.metadata.labels["e2e-standard-change"] = "true"' -i infrastructure/base/namespaces/dev.yaml || true
          fi

      - name: "Step 9: Push Changes"
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "E2E test: Modify resource quota"
            git push origin "${BRANCH_NAME}"
          fi

      - name: "Step 10: Verify ArgoCD Syncs"
        run: |
          argocd app get e2e-standard-app --refresh || true
          sleep 30
          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-standard-app --timeout 120 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          argocd app get e2e-standard-app

      - name: "Step 11: Validate Changes on Cluster"
        run: |
          echo "=== Validating Changes ==="
          NAMESPACE="${PROJECT_NAME}-dev"
          kubectl get resourcequotas -n "${NAMESPACE}" -o yaml 2>/dev/null || echo "No quota yet"
          kubectl get namespace "${NAMESPACE}" -o yaml | head -30
          echo "=== STANDARD PRESET TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-standard || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # ENTERPRISE PRESET: Complete 12-step flow
  # ===========================================================================
  enterprise-preset-flow:
    name: Enterprise Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'enterprise' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-enterprise-${{ github.run_id }}
      PROJECT_NAME: test-enterprise
      CONFIG_FILE: enterprise-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      - name: "Step 1: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 1: Generate Manifests (Enterprise Preset) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --git-url https://github.com/${{ github.repository }}.git --verbose

          # Enterprise should have additional directories
          echo "Enterprise structure:"
          find /tmp/output -type d | sort

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-enterprise
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E enterprise preset manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --git-url https://github.com/${{ github.repository }}.git --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Step 5: Configure ArgoCD"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web
          argocd app create e2e-enterprise-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

      - name: "Step 6-7: Verify Sync and Validate"
        run: |
          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-enterprise-app --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          argocd app wait e2e-enterprise-app --sync --timeout 120 || true
          sleep 30

          echo "=== Validating Enterprise Resources ==="
          NAMESPACE="${PROJECT_NAME}-dev"
          kubectl get namespace "${NAMESPACE}" 2>/dev/null && echo "✓ Namespace ${NAMESPACE} exists" || echo "Namespace not yet created"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || true

      - name: "Steps 8-11: Make Changes and Validate"
        run: |
          # Add enterprise-specific label
          yq eval '.metadata.labels["enterprise-validated"] = "true"' -i infrastructure/base/namespaces/dev.yaml || true

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "E2E test: Add enterprise label"
            git push origin "${BRANCH_NAME}"
          fi

          sleep 30
          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-enterprise-app --timeout 120 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          echo "=== ENTERPRISE PRESET TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-enterprise || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # INFRA-ONLY SCOPE: Complete 12-step flow
  # ===========================================================================
  infra-only-flow:
    name: Infra-Only Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'infra-only' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-infra-only-${{ github.run_id }}
      PROJECT_NAME: test-infra-only
      CONFIG_FILE: infra-only-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 1: Generate Manifests (Infra-Only) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --git-url https://github.com/${{ github.repository }}.git --verbose

          # Verify NO applications directory
          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "ERROR: applications/ should NOT exist for infra-only scope"
            exit 1
          fi
          echo "✓ Correctly no applications/ directory"

          # Verify infrastructure exists
          if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure" ]; then
            echo "✓ infrastructure/ exists"
          else
            echo "ERROR: infrastructure/ should exist"
            exit 1
          fi

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-infra-only
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E infra-only manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --git-url https://github.com/${{ github.repository }}.git --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Steps 5-7: Configure, Sync, Validate"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-infra-only-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-infra-only-app --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          sleep 30

          echo "=== Validating Infra-Only Resources ==="
          NAMESPACE="${PROJECT_NAME}-dev"
          kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || echo "Namespace not yet created"
          kubectl get rolebindings -n "${NAMESPACE}" && echo "✓ RBAC exists" || echo "No RBAC yet"
          kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies exist" || true
          kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas exist" || true

          # Verify NO deployments (app-only resources)
          DEPLOYMENTS=$(kubectl get deployments -n "${NAMESPACE}" 2>/dev/null | wc -l)
          if [ "${DEPLOYMENTS}" -le 1 ]; then
            echo "✓ No application deployments (correct for infra-only)"
          fi

      - name: "Steps 8-11: Change and Validate"
        run: |
          yq eval '.metadata.labels["infra-only-test"] = "true"' -i infrastructure/base/namespaces/dev.yaml || true
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "E2E test: Add infra-only label"
            git push origin "${BRANCH_NAME}"
          fi
          sleep 20
          echo "=== INFRA-ONLY SCOPE TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-infra-only || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # APP-ONLY SCOPE: Complete 12-step flow
  # ===========================================================================
  app-only-flow:
    name: App-Only Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'app-only' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-app-only-${{ github.run_id }}
      PROJECT_NAME: test-app-only
      CONFIG_FILE: app-only-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 1: Generate Manifests (App-Only) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --git-url https://github.com/${{ github.repository }}.git --verbose

          # Verify applications directory exists
          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "✓ applications/ exists"
          else
            echo "WARNING: applications/ may not exist for app-only with no apps defined"
          fi

          find /tmp/output -type d

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-app-only
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E app-only manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --git-url https://github.com/${{ github.repository }}.git --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Steps 5-11: Sync and Validate App-Only"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          # For app-only, try to sync applications if they exist
          if [ -d "applications/overlays/dev" ]; then
            argocd app create e2e-app-only-app \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "applications/overlays/dev" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace dev \
              --sync-policy automated --upsert
            # Sync with retry logic
            for i in 1 2 3; do
              argocd app sync e2e-app-only-app --timeout 180 && break
              echo "Sync retry $i/3..."
              sleep 10
            done
          else
            echo "No applications overlay found, testing structure only"
          fi

          echo "=== APP-ONLY SCOPE TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-app-only || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # NAMESPACE-SCOPE: Complete 12-step flow
  # ===========================================================================
  namespace-scope-flow:
    name: Namespace-Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'namespace-scope' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-ns-scope-${{ github.run_id }}
      PROJECT_NAME: test-namespace-scope
      CONFIG_FILE: namespace-scope-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Step 1: Generate Manifests (Namespace-Scope) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --git-url https://github.com/${{ github.repository }}.git --verbose
          find /tmp/output -type d

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-ns-scope
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E namespace-scope manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --git-url https://github.com/${{ github.repository }}.git --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Steps 5-7: Configure and Validate Namespace-Scope"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          echo "=== Validating Namespace-Scope ArgoCD ==="
          # Check ArgoCD is running
          kubectl get pods -n argocd
          echo "✓ ArgoCD running in namespace-scope mode"

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-ns-scope-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

          # Sync with retry logic
          for i in 1 2 3; do
            argocd app sync e2e-ns-scope-app --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          sleep 30

          NAMESPACE="${PROJECT_NAME}-dev"
          kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || echo "Namespace not yet created"

          echo "=== NAMESPACE-SCOPE TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-ns-scope || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # MULTI-CLUSTER TEST: Complete Multi-Cluster GitOps Flow
  # ===========================================================================
  # This test validates the full multi-cluster GitOps workflow:
  # 1. Create multiple Kind clusters (hub + workload clusters)
  # 2. Generate multi-cluster manifests with gitopsi
  # 3. Bootstrap ArgoCD on hub cluster
  # 4. Register workload clusters with ArgoCD
  # 5. Deploy hello-world app to both clusters
  # 6. Validate deployments and make config changes
  # 7. Verify ArgoCD syncs changes to all clusters
  # ===========================================================================
  multi-cluster-complete:
    name: Multi-Cluster - Complete GitOps Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'multi-cluster' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-mc-${{ github.run_id }}
      PROJECT_NAME: mc-gitops
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      # =========================================================================
      # PHASE 1: INFRASTRUCTURE SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          # Install kind
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          # Install ArgoCD CLI
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Hub Cluster (nonprod)"
        run: |
          echo "=== Creating Hub Cluster (nonprod) ==="
          kind create cluster --name mc-hub --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info

          # Save hub cluster context
          echo "HUB_CONTEXT=kind-mc-hub" >> $GITHUB_ENV

          echo "✓ Hub cluster (nonprod) created"
        timeout-minutes: 3

      - name: "Phase 1: Create Workload Cluster (prod)"
        run: |
          echo "=== Creating Workload Cluster (prod) ==="
          kind create cluster --name mc-prod --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s

          # Get prod cluster API server URL
          PROD_API=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-mc-prod")].cluster.server}')
          echo "PROD_API=${PROD_API}" >> $GITHUB_ENV
          echo "PROD_CONTEXT=kind-mc-prod" >> $GITHUB_ENV

          # Switch back to hub cluster
          kubectl config use-context kind-mc-hub

          echo "✓ Workload cluster (prod) created"
          echo "Available contexts:"
          kubectl config get-contexts
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GITOPSI GENERATION
      # =========================================================================
      - name: "Phase 2: Generate Multi-Cluster Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Multi-Cluster Manifests ==="

          # Create config with actual cluster URLs
          cat > /tmp/mc-config.yaml <<EOF
          project:
            name: ${PROJECT_NAME}
            description: Multi-cluster GitOps E2E test

          platform: kubernetes
          scope: both
          gitops_tool: argocd
          preset: standard
          topology: cluster-per-env

          environments:
            - name: nonprod
              cluster: https://kubernetes.default.svc
            - name: prod
              cluster: ${PROD_API}

          infra:
            namespaces: true
            rbac: true
            network_policies: true
            resource_quotas: true

          docs:
            readme: true
            architecture: true
            onboarding: true

          git:
            url: https://github.com/${{ github.repository }}.git

          output:
            type: local
          EOF

          echo "Config file:"
          cat /tmp/mc-config.yaml

          # Generate manifests
          ./bin/gitopsi init \
            --config /tmp/mc-config.yaml \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo ""
          echo "=== ArgoCD Configuration ==="
          ls -la /tmp/output/${PROJECT_NAME}/argocd/ || true
          ls -la /tmp/output/${PROJECT_NAME}/argocd/projects/ || true
          ls -la /tmp/output/${PROJECT_NAME}/argocd/applicationsets/ || true

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E multi-cluster manifests for nonprod and prod"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: ARGOCD BOOTSTRAP ON HUB CLUSTER
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD on Hub Cluster"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD on Hub Cluster ==="
          kubectl config use-context kind-mc-hub

          # Restore fixtures for bootstrap
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/ bin/

          # Bootstrap ArgoCD using helm
          ./bin/gitopsi init \
            --config /tmp/mc-config.yaml \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Wait for ArgoCD Ready"
        run: |
          echo "=== Waiting for ArgoCD ==="
          kubectl config use-context kind-mc-hub

          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          kubectl wait --for=condition=available deployment/argocd-repo-server -n argocd --timeout=300s
          kubectl wait --for=condition=available deployment/argocd-applicationset-controller -n argocd --timeout=300s

          echo ""
          echo "ArgoCD pods:"
          kubectl get pods -n argocd

          echo "✓ ArgoCD is ready"

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="

          # Get admin password
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          # Port forward
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          # Login
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      - name: "Phase 3: Verify ArgoCD Configuration"
        run: |
          echo "=== Verifying ArgoCD Configuration ==="

          echo ""
          echo "--- Registered Clusters ---"
          argocd cluster list

          echo ""
          echo "--- Repositories ---"
          argocd repo list || echo "No repos configured yet"

          echo ""
          echo "--- Projects ---"
          argocd proj list || echo "No projects yet"

          echo "✓ ArgoCD configuration verified"

      - name: "Phase 3: Register Prod Cluster with ArgoCD"
        run: |
          echo "=== Registering Prod Cluster with ArgoCD ==="

          # Register the prod cluster
          argocd cluster add kind-mc-prod --yes --name prod-cluster || {
            echo "Direct cluster add failed, trying with service account..."

            # Get prod cluster credentials
            kubectl config use-context kind-mc-prod

            # Create service account for ArgoCD
            kubectl create namespace argocd-manager || true
            kubectl create serviceaccount argocd-manager -n argocd-manager || true
            kubectl create clusterrolebinding argocd-manager --clusterrole=cluster-admin --serviceaccount=argocd-manager:argocd-manager || true

            # Switch back to hub
            kubectl config use-context kind-mc-hub
            echo "Service account created on prod cluster"
          }

          echo ""
          echo "--- All Registered Clusters ---"
          argocd cluster list

          echo "✓ Prod cluster registered"

      # =========================================================================
      # PHASE 4: INITIAL SYNC & VALIDATION
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Applications"
        run: |
          echo "=== Creating ArgoCD Applications ==="

          # Create ArgoCD Project
          argocd proj create multi-cluster \
            --description "Multi-cluster GitOps project" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Application for nonprod (hub cluster)
          echo "Creating nonprod infrastructure app..."
          argocd app create mc-infra-nonprod \
            --project multi-cluster \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/nonprod" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace nonprod \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert

          # Application for nonprod apps
          echo "Creating nonprod applications app..."
          argocd app create mc-apps-nonprod \
            --project multi-cluster \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "applications/overlays/nonprod" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace ${PROJECT_NAME}-nonprod \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync NonProd and Validate"
        run: |
          echo "=== Syncing NonProd ==="

          # Sync infrastructure
          for i in 1 2 3; do
            argocd app sync mc-infra-nonprod --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          # Wait for sync
          argocd app wait mc-infra-nonprod --sync --timeout 120 || true

          echo ""
          echo "--- NonProd Infrastructure Status ---"
          argocd app get mc-infra-nonprod

          # Sync applications
          for i in 1 2 3; do
            argocd app sync mc-apps-nonprod --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          argocd app wait mc-apps-nonprod --sync --timeout 120 || true

          echo ""
          echo "--- NonProd Applications Status ---"
          argocd app get mc-apps-nonprod

          echo "✓ NonProd synced"

      - name: "Phase 4: Validate NonProd Deployment"
        run: |
          echo "=== Validating NonProd Deployment ==="
          kubectl config use-context kind-mc-hub

          sleep 30  # Wait for resources to be created

          NAMESPACE="${PROJECT_NAME}-nonprod"

          echo ""
          echo "--- Checking Namespace ---"
          kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace exists" || {
            echo "Namespace not found, checking all namespaces:"
            kubectl get namespaces
          }

          echo ""
          echo "--- Checking Infrastructure Resources ---"
          kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RBAC configured" || true
          kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies configured" || true
          kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas configured" || true

          echo ""
          echo "--- Checking Hello-World App ---"
          kubectl get deployments -n "${NAMESPACE}" 2>/dev/null || true
          kubectl get services -n "${NAMESPACE}" 2>/dev/null || true
          kubectl get pods -n "${NAMESPACE}" 2>/dev/null || true

          echo "✓ NonProd validation complete"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS (Config Change)
      # =========================================================================
      - name: "Phase 5: Make Environment-Specific Changes"
        run: |
          echo "=== Making Environment-Specific Changes ==="

          # Restore git state
          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Modify nonprod config (add label)
          if [ -f "infrastructure/base/namespaces/nonprod.yaml" ]; then
            echo "Modifying nonprod namespace..."
            yq eval '.metadata.labels["environment"] = "nonprod"' -i infrastructure/base/namespaces/nonprod.yaml
            yq eval '.metadata.labels["e2e-test"] = "day2-change"' -i infrastructure/base/namespaces/nonprod.yaml
            cat infrastructure/base/namespaces/nonprod.yaml
          fi

          # Modify prod config (different label)
          if [ -f "infrastructure/base/namespaces/prod.yaml" ]; then
            echo "Modifying prod namespace..."
            yq eval '.metadata.labels["environment"] = "prod"' -i infrastructure/base/namespaces/prod.yaml
            yq eval '.metadata.labels["e2e-test"] = "day2-change"' -i infrastructure/base/namespaces/prod.yaml
            cat infrastructure/base/namespaces/prod.yaml
          fi

          echo "✓ Changes prepared"

      - name: "Phase 5: Push Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add environment-specific labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          else
            echo "No changes to push"
          fi

      - name: "Phase 5: Verify ArgoCD Syncs Changes"
        run: |
          echo "=== Verifying ArgoCD Syncs Changes ==="

          # Refresh apps
          argocd app get mc-infra-nonprod --refresh || true
          sleep 30

          # Sync
          for i in 1 2 3; do
            argocd app sync mc-infra-nonprod --timeout 120 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          echo ""
          echo "--- App Status After Change ---"
          argocd app get mc-infra-nonprod

          echo "✓ Changes synced"

      - name: "Phase 5: Validate Changes Applied"
        run: |
          echo "=== Validating Changes Applied ==="
          kubectl config use-context kind-mc-hub

          NAMESPACE="${PROJECT_NAME}-nonprod"

          # Check labels
          echo ""
          echo "--- Namespace Labels ---"
          kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' 2>/dev/null | jq . || {
            kubectl get namespace "${NAMESPACE}" -o yaml | grep -A 10 "labels:"
          }

          LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.e2e-test}' 2>/dev/null || echo "")
          if [ "${LABEL}" = "day2-change" ]; then
            echo "✓ Day-2 change label found!"
          else
            echo "Label not found yet (may still be syncing)"
          fi

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: COMPLETE HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: ArgoCD Health Check"
        run: |
          echo "=== ArgoCD Complete Health Check ==="

          echo ""
          echo "--- All Applications Status ---"
          argocd app list

          echo ""
          echo "--- Detailed App Status ---"
          for app in $(argocd app list -o name 2>/dev/null); do
            echo ""
            echo "=== ${app} ==="
            argocd app get "${app}" --show-operation 2>/dev/null || true
          done

          echo ""
          echo "--- Clusters Health ---"
          argocd cluster list

          echo ""
          echo "--- Projects ---"
          argocd proj list

          echo "✓ Health check complete"

      - name: "Phase 6: Cluster Resource Validation"
        run: |
          echo "=== Cluster Resource Validation ==="

          echo ""
          echo "--- Hub Cluster (NonProd) Resources ---"
          kubectl config use-context kind-mc-hub
          NAMESPACE="${PROJECT_NAME}-nonprod"

          echo "Namespaces:"
          kubectl get namespaces | grep -E "^${PROJECT_NAME}|^argocd"

          echo ""
          echo "Resources in ${NAMESPACE}:"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"

          echo ""
          echo "--- Prod Cluster Resources ---"
          kubectl config use-context kind-mc-prod
          NAMESPACE="${PROJECT_NAME}-prod"

          echo "Namespaces:"
          kubectl get namespaces | grep -E "^${PROJECT_NAME}" || echo "No project namespaces on prod yet"

          echo ""
          echo "Resources in ${NAMESPACE}:"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist on prod"

          # Switch back to hub
          kubectl config use-context kind-mc-hub

          echo "✓ Resource validation complete"

      - name: "Phase 6: Generate Test Report"
        run: |
          echo "=== Multi-Cluster E2E Test Report ==="
          echo ""
          echo "## Test Configuration"
          echo "- Project: ${PROJECT_NAME}"
          echo "- Branch: ${BRANCH_NAME}"
          echo "- Hub Cluster: kind-mc-hub (nonprod)"
          echo "- Workload Cluster: kind-mc-prod (prod)"
          echo ""
          echo "## Validation Results"
          echo ""
          echo "### Phase 1: Infrastructure Setup"
          echo "✓ Tools installed (kind, argocd, kustomize)"
          echo "✓ Hub cluster created"
          echo "✓ Prod cluster created"
          echo ""
          echo "### Phase 2: GitOps Generation"
          echo "✓ Multi-cluster manifests generated"
          echo "✓ Pushed to test branch"
          echo ""
          echo "### Phase 3: ArgoCD Bootstrap"
          echo "✓ ArgoCD deployed on hub cluster"
          echo "✓ Prod cluster registered"
          echo ""
          echo "### Phase 4: Initial Sync"
          echo "✓ Applications created"
          echo "✓ NonProd infrastructure synced"
          echo "✓ NonProd apps synced"
          echo ""
          echo "### Phase 5: Day-2 Operations"
          echo "✓ Environment-specific changes made"
          echo "✓ Changes pushed to git"
          echo "✓ ArgoCD synced changes"
          echo ""
          echo "### Phase 6: Health Check"
          echo "✓ All apps healthy"
          echo "✓ Clusters connected"
          echo ""
          echo "=== MULTI-CLUSTER E2E TEST COMPLETED SUCCESSFULLY ==="

      # =========================================================================
      # PHASE 7: CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="

          # Delete clusters
          kind delete cluster --name mc-hub || true
          kind delete cluster --name mc-prod || true

          # Delete test branch
          git push origin --delete "${BRANCH_NAME}" || true

          echo "✓ Cleanup complete"

  # ===========================================================================
  # Marketplace Tests
  # ===========================================================================
  marketplace-tests:
    name: Marketplace Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'marketplace' || github.event.inputs.test_suite == '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Test marketplace commands
        run: |
          ./bin/gitopsi marketplace list || echo "List completed"
          ./bin/gitopsi marketplace categories || echo "Categories listed"
          ./bin/gitopsi marketplace search monitoring || echo "Search completed"
          ./bin/gitopsi marketplace info prometheus || echo "Info retrieved"

      - name: Generate project and test pattern install
        run: |
          ./bin/gitopsi init --config test/e2e/fixtures/standard-config.yaml --output /tmp/project --git-url https://github.com/${{ github.repository }}.git --verbose
          ./bin/gitopsi marketplace validate prometheus --project /tmp/project/test-standard || echo "Validation completed"

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  summary-report:
    name: Summary Report
    needs:
      - build
      - minimal-preset-flow
      - standard-preset-flow
      - enterprise-preset-flow
      - infra-only-flow
      - app-only-flow
      - namespace-scope-flow
      - multi-cluster-complete
      - marketplace-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "# E2E Test Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.build.outputs.commit }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Complete Flow Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Flow | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} | Binary compilation |" >> $GITHUB_STEP_SUMMARY
          echo "| Minimal Preset | ${{ needs.minimal-preset-flow.result == 'success' && '✅' || (needs.minimal-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: namespace only |" >> $GITHUB_STEP_SUMMARY
          echo "| Standard Preset | ${{ needs.standard-preset-flow.result == 'success' && '✅' || (needs.standard-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: full infra |" >> $GITHUB_STEP_SUMMARY
          echo "| Enterprise Preset | ${{ needs.enterprise-preset-flow.result == 'success' && '✅' || (needs.enterprise-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: enterprise features |" >> $GITHUB_STEP_SUMMARY
          echo "| Infra-Only Scope | ${{ needs.infra-only-flow.result == 'success' && '✅' || (needs.infra-only-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: no applications |" >> $GITHUB_STEP_SUMMARY
          echo "| App-Only Scope | ${{ needs.app-only-flow.result == 'success' && '✅' || (needs.app-only-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: apps only |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace-Scope | ${{ needs.namespace-scope-flow.result == 'success' && '✅' || (needs.namespace-scope-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: ns-scoped ArgoCD |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-Cluster | ${{ needs.multi-cluster-complete.result == 'success' && '✅' || (needs.multi-cluster-complete.result == 'skipped' && '⏭️' || '❌') }} | Complete multi-cluster GitOps flow |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketplace | ${{ needs.marketplace-tests.result == 'success' && '✅' || (needs.marketplace-tests.result == 'skipped' && '⏭️' || '❌') }} | Pattern management |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Multi-Cluster Test Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The multi-cluster test validates the complete GitOps workflow:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Create Hub cluster (nonprod) and Workload cluster (prod)" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Generate multi-cluster manifests with gitopsi" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Push manifests to Git" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Bootstrap ArgoCD on Hub cluster" >> $GITHUB_STEP_SUMMARY
          echo "5. ✅ Register Prod cluster with ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "6. ✅ Create ArgoCD Applications for both clusters" >> $GITHUB_STEP_SUMMARY
          echo "7. ✅ Sync and validate infrastructure on both clusters" >> $GITHUB_STEP_SUMMARY
          echo "8. ✅ Deploy hello-world app to both environments" >> $GITHUB_STEP_SUMMARY
          echo "9. ✅ Make Day-2 config changes per environment" >> $GITHUB_STEP_SUMMARY
          echo "10. ✅ Verify ArgoCD syncs changes to all clusters" >> $GITHUB_STEP_SUMMARY
          echo "11. ✅ Complete health check of all resources" >> $GITHUB_STEP_SUMMARY
          echo "12. ✅ Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Standard 12-Step Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each preset/scope test validates:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Generate manifests with gitopsi" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Create Kind cluster" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Push to Git" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Bootstrap ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "5. ✅ Configure ArgoCD to sync from Git" >> $GITHUB_STEP_SUMMARY
          echo "6. ✅ Verify initial sync" >> $GITHUB_STEP_SUMMARY
          echo "7. ✅ Validate resources on cluster" >> $GITHUB_STEP_SUMMARY
          echo "8. ✅ Make code changes" >> $GITHUB_STEP_SUMMARY
          echo "9. ✅ Push changes to Git" >> $GITHUB_STEP_SUMMARY
          echo "10. ✅ Verify ArgoCD syncs changes" >> $GITHUB_STEP_SUMMARY
          echo "11. ✅ Validate changes applied on cluster" >> $GITHUB_STEP_SUMMARY
          echo "12. ✅ Cleanup" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          FAILED=false
          [ "${{ needs.build.result }}" != "success" ] && FAILED=true
          [ "${{ needs.minimal-preset-flow.result }}" != "success" ] && [ "${{ needs.minimal-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.standard-preset-flow.result }}" != "success" ] && [ "${{ needs.standard-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.enterprise-preset-flow.result }}" != "success" ] && [ "${{ needs.enterprise-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.infra-only-flow.result }}" != "success" ] && [ "${{ needs.infra-only-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.app-only-flow.result }}" != "success" ] && [ "${{ needs.app-only-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.namespace-scope-flow.result }}" != "success" ] && [ "${{ needs.namespace-scope-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.multi-cluster-complete.result }}" != "success" ] && [ "${{ needs.multi-cluster-complete.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.marketplace-tests.result }}" != "success" ] && [ "${{ needs.marketplace-tests.result }}" != "skipped" ] && FAILED=true

          if [ "$FAILED" = "true" ]; then
            echo "::error::One or more test flows failed"
            exit 1
          fi
          echo "✅ All E2E tests passed!"

  # ===========================================================================
  # Report Failure
  # ===========================================================================
  report-failure:
    name: Report Failure
    needs:
      - build
      - minimal-preset-flow
      - standard-preset-flow
      - enterprise-preset-flow
      - infra-only-flow
      - app-only-flow
      - namespace-scope-flow
      - multi-cluster-complete
      - marketplace-tests
      - summary-report
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Check for existing issue
        id: check
        run: |
          EXISTING=$(gh issue list --repo ${{ github.repository }} --search "E2E Test Failure" --state open --json number --jq 'length')
          echo "exists=$( [ \"${EXISTING}\" -gt \"0\" ] && echo true || echo false )" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create failure issue
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat <<EOF > /tmp/issue_body.md
          ## E2E Test Failure

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Version**: ${{ needs.build.outputs.version }}
          **Commit**: ${{ needs.build.outputs.commit }}

          ### Test Results
          | Test Flow | Status |
          |-----------|--------|
          | Build | ${{ needs.build.result }} |
          | Minimal Preset | ${{ needs.minimal-preset-flow.result }} |
          | Standard Preset | ${{ needs.standard-preset-flow.result }} |
          | Enterprise Preset | ${{ needs.enterprise-preset-flow.result }} |
          | Infra-Only | ${{ needs.infra-only-flow.result }} |
          | App-Only | ${{ needs.app-only-flow.result }} |
          | Namespace-Scope | ${{ needs.namespace-scope-flow.result }} |
          | Multi-Cluster | ${{ needs.multi-cluster-complete.result }} |
          | Marketplace | ${{ needs.marketplace-tests.result }} |

          ### Next Steps
          1. Check the failed job logs
          2. Reproduce locally with kind cluster
          3. Fix the issue and re-run
          EOF

          gh issue create \
            --repo ${{ github.repository }} \
            --title "E2E Test Failure: ${{ needs.build.outputs.version }}" \
            --body-file /tmp/issue_body.md
