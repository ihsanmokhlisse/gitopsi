name: E2E Full Test

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - minimal
          - standard
          - enterprise
          - infra-only
          - app-only
          - namespace-scope
          - multi-cluster
          - marketplace
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

concurrency:
  group: e2e-full-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.23'
  KIND_VERSION: 'v0.24.0'
  ARGOCD_VERSION: '2.13.2'
  TEST_BRANCH_PREFIX: 'test/e2e'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ===========================================================================
  # Build: Build gitopsi binary
  # ===========================================================================
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      commit: ${{ steps.info.outputs.commit }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate build info
        id: info
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "::notice::Version: ${VERSION}, Commit: ${COMMIT}"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build gitopsi binary
        run: |
          LDFLAGS="-s -w -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Version=${{ steps.info.outputs.version }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Commit=${{ steps.info.outputs.commit }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          CGO_ENABLED=0 go build -ldflags "${LDFLAGS}" -o bin/gitopsi ./cmd/gitopsi

      - name: Verify binary
        run: |
          ./bin/gitopsi version
          ./bin/gitopsi --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitopsi-binary
          path: bin/gitopsi
          retention-days: 1

  # ===========================================================================
  # MINIMAL PRESET: Complete GitOps Flow
  # ===========================================================================
  # Minimal preset tests the simplest configuration:
  # - Single environment (dev)
  # - Namespace only (no RBAC, no NetworkPolicies, no ResourceQuotas)
  # - Sample app deployment
  # ===========================================================================
  minimal-preset-flow:
    name: Minimal Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'minimal' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-minimal-${{ github.run_id }}
      PROJECT_NAME: test-minimal
      CONFIG_FILE: minimal-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable and preserve
        run: |
          chmod +x bin/gitopsi
          # Copy binary to /tmp to preserve it across git operations
          cp bin/gitopsi /tmp/gitopsi

      # =========================================================================
      # PHASE 1: SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Kind Cluster"
        run: |
          echo "=== Creating Kind Cluster ==="
          kind create cluster --name e2e-minimal --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
          echo "✓ Cluster created"
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GENERATE & PUSH
      # =========================================================================
      - name: "Phase 2: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Manifests (Minimal Preset) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo ""
          echo "=== Verifying Minimal Structure ==="
          # Minimal should have namespace but limited other resources
          if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure" ]; then
            echo "✓ infrastructure/ exists"
            ls -la /tmp/output/${PROJECT_NAME}/infrastructure/base/
          fi

          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "✓ applications/ exists"
            ls -la /tmp/output/${PROJECT_NAME}/applications/base/
          fi

          if [ -d "/tmp/output/${PROJECT_NAME}/argocd" ]; then
            echo "✓ argocd/ exists"
            ls -la /tmp/output/${PROJECT_NAME}/argocd/
          fi

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E minimal preset manifests"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: BOOTSTRAP ARGOCD
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD ==="
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          /tmp/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      # =========================================================================
      # PHASE 4: SYNC & VALIDATE
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Applications"
        run: |
          echo "=== Creating ArgoCD Applications ==="

          # Create project
          argocd proj create minimal-test \
            --description "Minimal preset test" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Infrastructure app
          argocd app create minimal-infra \
            --project minimal-test \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert

          # Applications app (if exists)
          if [ -d "applications/overlays/dev" ]; then
            argocd app create minimal-apps \
              --project minimal-test \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "applications/overlays/dev" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace ${PROJECT_NAME}-dev \
              --sync-policy automated \
              --auto-prune \
              --self-heal \
              --upsert
          fi

          echo ""
          argocd app list
          echo "✓ Applications created"

      - name: "Phase 4: Sync and Wait"
        run: |
          echo "=== Syncing Applications ==="

          # Sync infrastructure
          for i in 1 2 3; do
            argocd app sync minimal-infra --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done
          argocd app wait minimal-infra --sync --timeout 120 || true

          # Sync apps if exists
          if argocd app get minimal-apps &>/dev/null; then
            for i in 1 2 3; do
              argocd app sync minimal-apps --timeout 180 && break
              echo "Sync retry $i/3..."
              sleep 10
            done
            argocd app wait minimal-apps --sync --timeout 120 || true
          fi

          sleep 30
          echo "✓ Sync complete"

      - name: "Phase 4: Validate Deployment"
        run: |
          echo "=== Validating Deployment ==="

          NAMESPACE="${PROJECT_NAME}-dev"

          echo ""
          echo "--- Namespace Check ---"
          kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || {
            echo "Namespace not found, listing all:"
            kubectl get namespaces
          }

          echo ""
          echo "--- Infrastructure Resources ---"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || true

          echo ""
          echo "--- Sample App Check ---"
          if kubectl get deployment -n "${NAMESPACE}" 2>/dev/null | grep -q sample-app; then
            echo "✓ Sample app deployment found"
            kubectl get pods -n "${NAMESPACE}" -l app=sample-app

            # Wait for pod to be ready
            kubectl wait --for=condition=Ready pods -l app=sample-app -n "${NAMESPACE}" --timeout=120s || true

            # Check service
            kubectl get svc -n "${NAMESPACE}" -l app=sample-app && echo "✓ Sample app service found"
          else
            echo "No sample-app deployment (may be minimal config)"
          fi

          echo ""
          echo "--- ArgoCD Status ---"
          argocd app get minimal-infra --show-operation

          echo "✓ Validation complete"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS
      # =========================================================================
      - name: "Phase 5: Make Changes"
        run: |
          echo "=== Making Day-2 Changes ==="

          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Add environment label to namespace
          if [ -f "infrastructure/base/namespaces/dev.yaml" ]; then
            echo "Modifying namespace..."
            yq eval '.metadata.labels["environment"] = "dev"' -i infrastructure/base/namespaces/dev.yaml
            yq eval '.metadata.labels["e2e-test"] = "minimal-day2"' -i infrastructure/base/namespaces/dev.yaml
            echo "Modified:"
            cat infrastructure/base/namespaces/dev.yaml
          fi

          echo "✓ Changes prepared"

      - name: "Phase 5: Push and Sync"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add environment labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          fi

          # Sync
          argocd app get minimal-infra --refresh || true
          sleep 20

          for i in 1 2 3; do
            argocd app sync minimal-infra --timeout 120 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          echo "✓ Sync triggered"

      - name: "Phase 5: Validate Changes"
        run: |
          echo "=== Validating Changes ==="

          NAMESPACE="${PROJECT_NAME}-dev"
          sleep 10

          LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.e2e-test}' 2>/dev/null || echo "")
          if [ "${LABEL}" = "minimal-day2" ]; then
            echo "✓ Day-2 label found on namespace!"
          else
            echo "Label not yet applied, current labels:"
            kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' | jq . || true
          fi

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: Final Health Check"
        run: |
          echo "=== Final Health Check ==="

          echo ""
          echo "--- ArgoCD Applications ---"
          argocd app list

          echo ""
          echo "--- App Details ---"
          argocd app get minimal-infra

          echo ""
          echo "--- Cluster Resources ---"
          NAMESPACE="${PROJECT_NAME}-dev"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || true

          echo ""
          echo "=== MINIMAL PRESET TEST COMPLETED ==="

      # =========================================================================
      # CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="
          kind delete cluster --name e2e-minimal || true
          git push origin --delete "${BRANCH_NAME}" || true
          echo "✓ Cleanup complete"

  # ===========================================================================
  # STANDARD PRESET: Complete GitOps Flow (3 Environments)
  # ===========================================================================
  # Standard preset tests a typical production setup:
  # - Three environments (dev, staging, prod)
  # - Full infrastructure (RBAC, NetworkPolicies, ResourceQuotas)
  # - Sample app deployment to all environments
  # ===========================================================================
  standard-preset-flow:
    name: Standard Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'standard' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-standard-${{ github.run_id }}
      PROJECT_NAME: test-standard
      CONFIG_FILE: standard-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable and preserve
        run: |
          chmod +x bin/gitopsi
          # Copy binary to /tmp to preserve it across git operations
          cp bin/gitopsi /tmp/gitopsi

      # =========================================================================
      # PHASE 1: SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Kind Cluster"
        run: |
          echo "=== Creating Kind Cluster ==="
          kind create cluster --name e2e-standard --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
          echo "✓ Cluster created"
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GENERATE & PUSH
      # =========================================================================
      - name: "Phase 2: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Manifests (Standard Preset) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo ""
          echo "=== Verifying Standard Structure ==="
          # Standard should have all 3 environment overlays
          for env in dev staging prod; do
            if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure/overlays/${env}" ]; then
              echo "✓ infrastructure/overlays/${env}/ exists"
            else
              echo "✗ Missing infrastructure/overlays/${env}/"
            fi
          done

          # Check ArgoCD configuration
          if [ -d "/tmp/output/${PROJECT_NAME}/argocd" ]; then
            echo "✓ argocd/ exists"
            ls -la /tmp/output/${PROJECT_NAME}/argocd/
            ls -la /tmp/output/${PROJECT_NAME}/argocd/projects/ 2>/dev/null || true
          fi

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E standard preset manifests (dev, staging, prod)"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: BOOTSTRAP ARGOCD
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD ==="
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          /tmp/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      # =========================================================================
      # PHASE 4: SYNC & VALIDATE ALL ENVIRONMENTS
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Project and Apps"
        run: |
          echo "=== Creating ArgoCD Project and Applications ==="

          # Create project
          argocd proj create standard-test \
            --description "Standard preset test (dev, staging, prod)" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Create apps for all 3 environments
          for env in dev staging prod; do
            echo ""
            echo "--- Creating apps for ${env} ---"

            # Infrastructure app
            argocd app create standard-infra-${env} \
              --project standard-test \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "infrastructure/overlays/${env}" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace ${PROJECT_NAME}-${env} \
              --sync-policy automated \
              --auto-prune \
              --self-heal \
              --upsert

            # Applications app (if overlay exists)
            if [ -d "applications/overlays/${env}" ] 2>/dev/null || [ -d "/tmp/output/${PROJECT_NAME}/applications/overlays/${env}" ]; then
              argocd app create standard-apps-${env} \
                --project standard-test \
                --repo https://github.com/${{ github.repository }}.git \
                --revision "${BRANCH_NAME}" \
                --path "applications/overlays/${env}" \
                --dest-server https://kubernetes.default.svc \
                --dest-namespace ${PROJECT_NAME}-${env} \
                --sync-policy automated \
                --auto-prune \
                --self-heal \
                --upsert || echo "No apps overlay for ${env}"
            fi
          done

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync All Environments"
        run: |
          echo "=== Syncing All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "--- Syncing ${env} ---"

            # Sync infrastructure
            for i in 1 2 3; do
              argocd app sync standard-infra-${env} --timeout 180 && break
              echo "Sync retry $i/3..."
              sleep 10
            done
            argocd app wait standard-infra-${env} --sync --timeout 120 || true

            # Sync apps if exists
            if argocd app get standard-apps-${env} &>/dev/null; then
              for i in 1 2 3; do
                argocd app sync standard-apps-${env} --timeout 180 && break
                echo "Sync retry $i/3..."
                sleep 10
              done
              argocd app wait standard-apps-${env} --sync --timeout 120 || true
            fi
          done

          sleep 30
          echo "✓ All environments synced"

      - name: "Phase 4: Validate All Environments"
        run: |
          echo "=== Validating All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "=========================================="
            echo "Validating ${env} environment"
            echo "=========================================="

            NAMESPACE="${PROJECT_NAME}-${env}"

            echo ""
            echo "--- Namespace Check ---"
            kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || {
              echo "Namespace not found"
              continue
            }

            echo ""
            echo "--- Infrastructure Resources ---"
            echo "RBAC:"
            kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RoleBindings found" || echo "No RoleBindings"

            echo "NetworkPolicies:"
            kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies found" || echo "No NetworkPolicies"

            echo "ResourceQuotas:"
            kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas found" || echo "No ResourceQuotas"

            echo ""
            echo "--- Sample App Check ---"
            if kubectl get deployment -n "${NAMESPACE}" 2>/dev/null | grep -q sample-app; then
              echo "✓ Sample app deployment found"
              kubectl get pods -n "${NAMESPACE}" -l app=sample-app 2>/dev/null || true
            else
              echo "No sample-app deployment in ${env}"
            fi
          done

          echo ""
          echo "--- ArgoCD Application Status ---"
          argocd app list

          echo "✓ All environments validated"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS
      # =========================================================================
      - name: "Phase 5: Make Environment-Specific Changes"
        run: |
          echo "=== Making Day-2 Changes ==="

          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Add environment-specific labels to each namespace
          for env in dev staging prod; do
            if [ -f "infrastructure/base/namespaces/${env}.yaml" ]; then
              echo "Modifying ${env} namespace..."
              yq eval ".metadata.labels[\"environment\"] = \"${env}\"" -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["e2e-test"] = "standard-day2"' -i infrastructure/base/namespaces/${env}.yaml
              echo "Modified ${env}:"
              cat infrastructure/base/namespaces/${env}.yaml
              echo ""
            fi
          done

          # Modify prod ResourceQuota if exists
          if [ -f "infrastructure/base/resource-quotas/prod.yaml" ]; then
            echo "Modifying prod resource quota..."
            yq eval '.spec.hard["limits.cpu"] = "50"' -i infrastructure/base/resource-quotas/prod.yaml
            cat infrastructure/base/resource-quotas/prod.yaml
          fi

          echo "✓ Changes prepared"

      - name: "Phase 5: Push and Sync Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add environment labels and modify prod quota"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          fi

          # Refresh and sync all apps
          echo ""
          echo "--- Syncing all apps ---"
          for env in dev staging prod; do
            argocd app get standard-infra-${env} --refresh || true
          done

          sleep 20

          for env in dev staging prod; do
            for i in 1 2 3; do
              argocd app sync standard-infra-${env} --timeout 120 && break
              echo "Sync retry $i/3 for ${env}..."
              sleep 10
            done
          done

          echo "✓ Sync triggered"

      - name: "Phase 5: Validate Changes Applied"
        run: |
          echo "=== Validating Changes Applied ==="

          sleep 15

          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "--- Checking ${env} labels ---"

            LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.e2e-test}' 2>/dev/null || echo "")
            if [ "${LABEL}" = "standard-day2" ]; then
              echo "✓ Day-2 label found on ${env} namespace!"
            else
              echo "Label not yet applied to ${env}"
              kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' 2>/dev/null | jq . || true
            fi
          done

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: Final Health Check"
        run: |
          echo "=== Final Health Check ==="

          echo ""
          echo "--- ArgoCD Applications ---"
          argocd app list

          echo ""
          echo "--- Detailed Status per Environment ---"
          for env in dev staging prod; do
            echo ""
            echo "=== ${env} ==="
            argocd app get standard-infra-${env} --show-operation 2>/dev/null || true
          done

          echo ""
          echo "--- All Cluster Resources ---"
          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "=== Resources in ${NAMESPACE} ==="
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"
          done

          echo ""
          echo "=== STANDARD PRESET TEST COMPLETED ==="

      # =========================================================================
      # CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="
          kind delete cluster --name e2e-standard || true
          git push origin --delete "${BRANCH_NAME}" || true
          echo "✓ Cleanup complete"

  # ===========================================================================
  # ENTERPRISE PRESET: Complete GitOps Flow (3 Environments + Enterprise Features)
  # ===========================================================================
  # Enterprise preset tests a full enterprise setup:
  # - Three environments (dev, staging, prod)
  # - Full infrastructure (RBAC, NetworkPolicies, ResourceQuotas)
  # - Enterprise features (monitoring, alerts, policies directories)
  # - Sample app deployment to all environments
  # ===========================================================================
  enterprise-preset-flow:
    name: Enterprise Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'enterprise' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-enterprise-${{ github.run_id }}
      PROJECT_NAME: test-enterprise
      CONFIG_FILE: enterprise-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable and preserve
        run: |
          chmod +x bin/gitopsi
          # Copy binary to /tmp to preserve it across git operations
          cp bin/gitopsi /tmp/gitopsi

      # =========================================================================
      # PHASE 1: SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Kind Cluster"
        run: |
          echo "=== Creating Kind Cluster ==="
          kind create cluster --name e2e-enterprise --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
          echo "✓ Cluster created"
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GENERATE & PUSH
      # =========================================================================
      - name: "Phase 2: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Manifests (Enterprise Preset) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type d | sort

          echo ""
          echo "=== Verifying Enterprise Structure ==="
          # Enterprise should have all 3 environment overlays
          for env in dev staging prod; do
            if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure/overlays/${env}" ]; then
              echo "✓ infrastructure/overlays/${env}/ exists"
            else
              echo "✗ Missing infrastructure/overlays/${env}/"
            fi
          done

          # Enterprise-specific directories (monitoring, alerts, policies)
          for dir in monitoring alerts policies; do
            if [ -d "/tmp/output/${PROJECT_NAME}/${dir}" ]; then
              echo "✓ ${dir}/ exists (enterprise feature)"
            else
              echo "○ ${dir}/ not present (may not be generated)"
            fi
          done

          # Check ArgoCD configuration
          if [ -d "/tmp/output/${PROJECT_NAME}/argocd" ]; then
            echo "✓ argocd/ exists"
            ls -la /tmp/output/${PROJECT_NAME}/argocd/
          fi

          echo ""
          echo "=== All YAML files ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E enterprise preset manifests (dev, staging, prod + enterprise features)"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: BOOTSTRAP ARGOCD
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD ==="
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          /tmp/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      # =========================================================================
      # PHASE 4: SYNC & VALIDATE ALL ENVIRONMENTS
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Project and Apps"
        run: |
          echo "=== Creating ArgoCD Project and Applications ==="

          # Create project
          argocd proj create enterprise-test \
            --description "Enterprise preset test (dev, staging, prod)" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Create apps for all 3 environments
          for env in dev staging prod; do
            echo ""
            echo "--- Creating apps for ${env} ---"

            # Infrastructure app
            argocd app create enterprise-infra-${env} \
              --project enterprise-test \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "infrastructure/overlays/${env}" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace ${PROJECT_NAME}-${env} \
              --sync-policy automated \
              --auto-prune \
              --self-heal \
              --upsert

            # Applications app (if overlay exists)
            if [ -d "applications/overlays/${env}" ] 2>/dev/null || [ -d "/tmp/output/${PROJECT_NAME}/applications/overlays/${env}" ]; then
              argocd app create enterprise-apps-${env} \
                --project enterprise-test \
                --repo https://github.com/${{ github.repository }}.git \
                --revision "${BRANCH_NAME}" \
                --path "applications/overlays/${env}" \
                --dest-server https://kubernetes.default.svc \
                --dest-namespace ${PROJECT_NAME}-${env} \
                --sync-policy automated \
                --auto-prune \
                --self-heal \
                --upsert || echo "No apps overlay for ${env}"
            fi
          done

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync All Environments"
        run: |
          echo "=== Syncing All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "--- Syncing ${env} ---"

            # Sync infrastructure
            for i in 1 2 3; do
              argocd app sync enterprise-infra-${env} --timeout 180 && break
              echo "Sync retry $i/3..."
              sleep 10
            done
            argocd app wait enterprise-infra-${env} --sync --timeout 120 || true

            # Sync apps if exists
            if argocd app get enterprise-apps-${env} &>/dev/null; then
              for i in 1 2 3; do
                argocd app sync enterprise-apps-${env} --timeout 180 && break
                echo "Sync retry $i/3..."
                sleep 10
              done
              argocd app wait enterprise-apps-${env} --sync --timeout 120 || true
            fi
          done

          sleep 30
          echo "✓ All environments synced"

      - name: "Phase 4: Validate All Environments"
        run: |
          echo "=== Validating All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "=========================================="
            echo "Validating ${env} environment"
            echo "=========================================="

            NAMESPACE="${PROJECT_NAME}-${env}"

            echo ""
            echo "--- Namespace Check ---"
            kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || {
              echo "Namespace not found"
              continue
            }

            echo ""
            echo "--- Infrastructure Resources ---"
            echo "RBAC:"
            kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RoleBindings found" || echo "No RoleBindings"

            echo "NetworkPolicies:"
            kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies found" || echo "No NetworkPolicies"

            echo "ResourceQuotas:"
            kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas found" || echo "No ResourceQuotas"

            echo ""
            echo "--- All Resources ---"
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || true
          done

          echo ""
          echo "--- ArgoCD Application Status ---"
          argocd app list

          echo "✓ All environments validated"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS
      # =========================================================================
      - name: "Phase 5: Make Environment-Specific Changes"
        run: |
          echo "=== Making Day-2 Changes ==="

          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Add enterprise-specific labels to each namespace
          for env in dev staging prod; do
            if [ -f "infrastructure/base/namespaces/${env}.yaml" ]; then
              echo "Modifying ${env} namespace..."
              yq eval ".metadata.labels[\"environment\"] = \"${env}\"" -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["e2e-test"] = "enterprise-day2"' -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["tier"] = "enterprise"' -i infrastructure/base/namespaces/${env}.yaml
              echo "Modified ${env}:"
              cat infrastructure/base/namespaces/${env}.yaml
              echo ""
            fi
          done

          echo "✓ Changes prepared"

      - name: "Phase 5: Push and Sync Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add enterprise tier labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          fi

          # Refresh and sync all apps
          echo ""
          echo "--- Syncing all apps ---"
          for env in dev staging prod; do
            argocd app get enterprise-infra-${env} --refresh || true
          done

          sleep 20

          for env in dev staging prod; do
            for i in 1 2 3; do
              argocd app sync enterprise-infra-${env} --timeout 120 && break
              echo "Sync retry $i/3 for ${env}..."
              sleep 10
            done
          done

          echo "✓ Sync triggered"

      - name: "Phase 5: Validate Changes Applied"
        run: |
          echo "=== Validating Changes Applied ==="

          sleep 15

          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "--- Checking ${env} labels ---"

            LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.tier}' 2>/dev/null || echo "")
            if [ "${LABEL}" = "enterprise" ]; then
              echo "✓ Enterprise tier label found on ${env} namespace!"
            else
              echo "Label not yet applied to ${env}"
              kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' 2>/dev/null | jq . || true
            fi
          done

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: Final Health Check"
        run: |
          echo "=== Final Health Check ==="

          echo ""
          echo "--- ArgoCD Applications ---"
          argocd app list

          echo ""
          echo "--- Detailed Status per Environment ---"
          for env in dev staging prod; do
            echo ""
            echo "=== ${env} ==="
            argocd app get enterprise-infra-${env} --show-operation 2>/dev/null || true
          done

          echo ""
          echo "--- All Cluster Resources ---"
          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "=== Resources in ${NAMESPACE} ==="
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"
          done

          echo ""
          echo "=== ENTERPRISE PRESET TEST COMPLETED ==="

      # =========================================================================
      # CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="
          kind delete cluster --name e2e-enterprise || true
          git push origin --delete "${BRANCH_NAME}" || true
          echo "✓ Cleanup complete"

  # ===========================================================================
  # INFRA-ONLY SCOPE: Complete GitOps Flow (Infrastructure Only, No Apps)
  # ===========================================================================
  # Infra-only scope tests infrastructure-only generation:
  # - Three environments (dev, staging, prod)
  # - Full infrastructure (RBAC, NetworkPolicies, ResourceQuotas)
  # - NO applications directory or deployments
  # ===========================================================================
  infra-only-flow:
    name: Infra-Only Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'infra-only' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-infra-only-${{ github.run_id }}
      PROJECT_NAME: test-infra-only
      CONFIG_FILE: infra-only-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable and preserve
        run: |
          chmod +x bin/gitopsi
          # Copy binary to /tmp to preserve it across git operations
          cp bin/gitopsi /tmp/gitopsi

      # =========================================================================
      # PHASE 1: SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Kind Cluster"
        run: |
          echo "=== Creating Kind Cluster ==="
          kind create cluster --name e2e-infra-only --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
          echo "✓ Cluster created"
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GENERATE & PUSH
      # =========================================================================
      - name: "Phase 2: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Manifests (Infra-Only Scope) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type d | sort

          echo ""
          echo "=== Verifying Infra-Only Structure ==="

          # Verify NO applications directory
          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "✗ ERROR: applications/ should NOT exist for infra-only scope"
            find /tmp/output/${PROJECT_NAME}/applications -type f | head -5
            exit 1
          fi
          echo "✓ Correctly no applications/ directory"

          # Verify infrastructure exists
          if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure" ]; then
            echo "✓ infrastructure/ exists"
          else
            echo "✗ ERROR: infrastructure/ should exist"
            exit 1
          fi

          # Verify all 3 environment overlays
          for env in dev staging prod; do
            if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure/overlays/${env}" ]; then
              echo "✓ infrastructure/overlays/${env}/ exists"
            else
              echo "✗ Missing infrastructure/overlays/${env}/"
            fi
          done

          echo ""
          echo "=== All YAML files ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E infra-only manifests (dev, staging, prod)"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: BOOTSTRAP ARGOCD
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD ==="
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          /tmp/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      # =========================================================================
      # PHASE 4: SYNC & VALIDATE ALL ENVIRONMENTS
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Project and Apps"
        run: |
          echo "=== Creating ArgoCD Project and Applications ==="

          # Create project
          argocd proj create infra-only-test \
            --description "Infra-only scope test (dev, staging, prod)" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Create infrastructure apps for all 3 environments
          for env in dev staging prod; do
            echo ""
            echo "--- Creating infra app for ${env} ---"

            argocd app create infra-only-${env} \
              --project infra-only-test \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "infrastructure/overlays/${env}" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace ${PROJECT_NAME}-${env} \
              --sync-policy automated \
              --auto-prune \
              --self-heal \
              --upsert
          done

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync All Environments"
        run: |
          echo "=== Syncing All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "--- Syncing ${env} ---"

            for i in 1 2 3; do
              argocd app sync infra-only-${env} --timeout 180 && break
              echo "Sync retry $i/3..."
              sleep 10
            done
            argocd app wait infra-only-${env} --sync --timeout 120 || true
          done

          sleep 30
          echo "✓ All environments synced"

      - name: "Phase 4: Validate All Environments"
        run: |
          echo "=== Validating All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "=========================================="
            echo "Validating ${env} environment"
            echo "=========================================="

            NAMESPACE="${PROJECT_NAME}-${env}"

            echo ""
            echo "--- Namespace Check ---"
            kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || {
              echo "Namespace not found"
              continue
            }

            echo ""
            echo "--- Infrastructure Resources ---"
            echo "RBAC:"
            kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RoleBindings found" || echo "No RoleBindings"

            echo "NetworkPolicies:"
            kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies found" || echo "No NetworkPolicies"

            echo "ResourceQuotas:"
            kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas found" || echo "No ResourceQuotas"

            echo ""
            echo "--- Verify NO Application Deployments ---"
            DEPLOYMENTS=$(kubectl get deployments -n "${NAMESPACE}" 2>/dev/null | grep -v "^NAME" | wc -l || echo "0")
            if [ "${DEPLOYMENTS}" -eq 0 ]; then
              echo "✓ No application deployments (correct for infra-only)"
            else
              echo "✗ Found ${DEPLOYMENTS} deployments (should be 0 for infra-only)"
              kubectl get deployments -n "${NAMESPACE}" 2>/dev/null
            fi
          done

          echo ""
          echo "--- ArgoCD Application Status ---"
          argocd app list

          echo "✓ All environments validated"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS
      # =========================================================================
      - name: "Phase 5: Make Environment-Specific Changes"
        run: |
          echo "=== Making Day-2 Changes ==="

          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Add infra-only labels to each namespace
          for env in dev staging prod; do
            if [ -f "infrastructure/base/namespaces/${env}.yaml" ]; then
              echo "Modifying ${env} namespace..."
              yq eval ".metadata.labels[\"environment\"] = \"${env}\"" -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["e2e-test"] = "infra-only-day2"' -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["scope"] = "infrastructure"' -i infrastructure/base/namespaces/${env}.yaml
              echo "Modified ${env}:"
              cat infrastructure/base/namespaces/${env}.yaml
              echo ""
            fi
          done

          echo "✓ Changes prepared"

      - name: "Phase 5: Push and Sync Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add infra-only scope labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          fi

          # Refresh and sync all apps
          echo ""
          echo "--- Syncing all apps ---"
          for env in dev staging prod; do
            argocd app get infra-only-${env} --refresh || true
          done

          sleep 20

          for env in dev staging prod; do
            for i in 1 2 3; do
              argocd app sync infra-only-${env} --timeout 120 && break
              echo "Sync retry $i/3 for ${env}..."
              sleep 10
            done
          done

          echo "✓ Sync triggered"

      - name: "Phase 5: Validate Changes Applied"
        run: |
          echo "=== Validating Changes Applied ==="

          sleep 15

          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "--- Checking ${env} labels ---"

            LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.scope}' 2>/dev/null || echo "")
            if [ "${LABEL}" = "infrastructure" ]; then
              echo "✓ Scope=infrastructure label found on ${env} namespace!"
            else
              echo "Label not yet applied to ${env}"
              kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' 2>/dev/null | jq . || true
            fi
          done

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: Final Health Check"
        run: |
          echo "=== Final Health Check ==="

          echo ""
          echo "--- ArgoCD Applications ---"
          argocd app list

          echo ""
          echo "--- Detailed Status per Environment ---"
          for env in dev staging prod; do
            echo ""
            echo "=== ${env} ==="
            argocd app get infra-only-${env} --show-operation 2>/dev/null || true
          done

          echo ""
          echo "--- All Cluster Resources ---"
          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "=== Resources in ${NAMESPACE} ==="
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"

            # Final verification: NO deployments
            DEPLOYMENTS=$(kubectl get deployments -n "${NAMESPACE}" 2>/dev/null | grep -v "^NAME" | wc -l || echo "0")
            if [ "${DEPLOYMENTS}" -eq 0 ]; then
              echo "✓ Verified: No deployments in ${env} (correct for infra-only)"
            fi
          done

          echo ""
          echo "=== INFRA-ONLY SCOPE TEST COMPLETED ==="

      # =========================================================================
      # CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="
          kind delete cluster --name e2e-infra-only || true
          git push origin --delete "${BRANCH_NAME}" || true
          echo "✓ Cleanup complete"

  # ===========================================================================
  # APP-ONLY SCOPE: Complete GitOps Flow (Applications Only, No Infra)
  # ===========================================================================
  # App-only scope tests application-only generation:
  # - Three environments (dev, staging, prod)
  # - Application deployments only
  # - Minimal or NO infrastructure (no RBAC, NetworkPolicies, ResourceQuotas)
  # ===========================================================================
  app-only-flow:
    name: App-Only Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'app-only' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-app-only-${{ github.run_id }}
      PROJECT_NAME: test-app-only
      CONFIG_FILE: app-only-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable and preserve
        run: |
          chmod +x bin/gitopsi
          # Copy binary to /tmp to preserve it across git operations
          cp bin/gitopsi /tmp/gitopsi

      # =========================================================================
      # PHASE 1: SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Kind Cluster"
        run: |
          echo "=== Creating Kind Cluster ==="
          kind create cluster --name e2e-app-only --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
          echo "✓ Cluster created"
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GENERATE & PUSH
      # =========================================================================
      - name: "Phase 2: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Manifests (App-Only Scope) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type d | sort

          echo ""
          echo "=== Verifying App-Only Structure ==="

          # Verify applications directory exists
          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "✓ applications/ exists"
          else
            echo "○ applications/ may not exist (depends on apps defined in config)"
          fi

          # Verify NO or minimal infrastructure
          if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure" ]; then
            echo "○ infrastructure/ exists (may have namespaces only)"
            find /tmp/output/${PROJECT_NAME}/infrastructure -type f -name "*.yaml" | head -5
          else
            echo "✓ Correctly no infrastructure/ directory"
          fi

          # Verify all 3 environment overlays for applications (if present)
          for env in dev staging prod; do
            if [ -d "/tmp/output/${PROJECT_NAME}/applications/overlays/${env}" ]; then
              echo "✓ applications/overlays/${env}/ exists"
            else
              echo "○ Missing applications/overlays/${env}/"
            fi
          done

          echo ""
          echo "=== All YAML files ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E app-only manifests (dev, staging, prod)"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: BOOTSTRAP ARGOCD
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD ==="
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          /tmp/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      - name: "Phase 3: Create Namespaces for App Deployment"
        run: |
          echo "=== Creating Namespaces ==="
          # App-only scope may not create namespaces, so we create them manually
          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            kubectl create namespace "${NAMESPACE}" 2>/dev/null || echo "Namespace ${NAMESPACE} already exists"
          done
          echo "✓ Namespaces ready"

      # =========================================================================
      # PHASE 4: SYNC & VALIDATE ALL ENVIRONMENTS
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Project and Apps"
        run: |
          echo "=== Creating ArgoCD Project and Applications ==="

          # Create project
          argocd proj create app-only-test \
            --description "App-only scope test (dev, staging, prod)" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Create application apps for all 3 environments
          for env in dev staging prod; do
            echo ""
            echo "--- Creating app for ${env} ---"

            NAMESPACE="${PROJECT_NAME}-${env}"

            # Check if applications overlay exists
            if [ -d "applications/overlays/${env}" ] || [ -d "/tmp/output/${PROJECT_NAME}/applications/overlays/${env}" ]; then
              argocd app create app-only-${env} \
                --project app-only-test \
                --repo https://github.com/${{ github.repository }}.git \
                --revision "${BRANCH_NAME}" \
                --path "applications/overlays/${env}" \
                --dest-server https://kubernetes.default.svc \
                --dest-namespace ${NAMESPACE} \
                --sync-policy automated \
                --auto-prune \
                --self-heal \
                --upsert
            else
              echo "○ No applications overlay for ${env}"
            fi
          done

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync All Environments"
        run: |
          echo "=== Syncing All Environments ==="

          for env in dev staging prod; do
            if argocd app get app-only-${env} &>/dev/null; then
              echo ""
              echo "--- Syncing ${env} ---"

              for i in 1 2 3; do
                argocd app sync app-only-${env} --timeout 180 && break
                echo "Sync retry $i/3..."
                sleep 10
              done
              argocd app wait app-only-${env} --sync --timeout 120 || true
            else
              echo "○ Skipping ${env} - no app created"
            fi
          done

          sleep 30
          echo "✓ All environments synced"

      - name: "Phase 4: Validate All Environments"
        run: |
          echo "=== Validating All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "=========================================="
            echo "Validating ${env} environment"
            echo "=========================================="

            NAMESPACE="${PROJECT_NAME}-${env}"

            echo ""
            echo "--- Namespace Check ---"
            kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || {
              echo "Namespace not found"
              continue
            }

            echo ""
            echo "--- Application Resources ---"
            echo "Deployments:"
            kubectl get deployments -n "${NAMESPACE}" 2>/dev/null || echo "No Deployments"

            echo "Pods:"
            kubectl get pods -n "${NAMESPACE}" 2>/dev/null || echo "No Pods"

            echo "Services:"
            kubectl get services -n "${NAMESPACE}" 2>/dev/null || echo "No Services"

            echo ""
            echo "--- Verify Minimal Infrastructure ---"
            RBAC=$(kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null | grep -v "^NAME" | wc -l || echo "0")
            NETPOL=$(kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null | grep -v "^NAME" | wc -l || echo "0")

            if [ "${RBAC}" -eq 0 ] && [ "${NETPOL}" -eq 0 ]; then
              echo "✓ Minimal infrastructure (correct for app-only)"
            else
              echo "○ Found some infrastructure resources"
            fi
          done

          echo ""
          echo "--- ArgoCD Application Status ---"
          argocd app list

          echo "✓ All environments validated"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS
      # =========================================================================
      - name: "Phase 5: Make Application Changes"
        run: |
          echo "=== Making Day-2 Changes ==="

          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Add app-only labels or modify applications
          for env in dev staging prod; do
            # Try to find deployment manifests and modify them
            DEPLOY_FILE="applications/base/sample-app/deployment.yaml"
            if [ -f "${DEPLOY_FILE}" ]; then
              echo "Modifying deployment..."
              yq eval '.metadata.labels["e2e-test"] = "app-only-day2"' -i "${DEPLOY_FILE}"
              yq eval '.metadata.labels["scope"] = "application"' -i "${DEPLOY_FILE}"
              echo "Modified deployment:"
              cat "${DEPLOY_FILE}" | head -20
              break
            fi
          done

          # If no deployment found, add a configmap
          if [ ! -f "applications/base/e2e-test-config.yaml" ]; then
            mkdir -p applications/base
            echo "apiVersion: v1
          kind: ConfigMap
          metadata:
            name: e2e-test-config
            labels:
              e2e-test: app-only-day2
              scope: application
          data:
            test: day2-change" | sed 's/^          //' > applications/base/e2e-test-config.yaml
            echo "Created test configmap"
          fi

          echo "✓ Changes prepared"

      - name: "Phase 5: Push and Sync Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add app-only scope labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          fi

          # Refresh and sync apps
          echo ""
          echo "--- Syncing apps ---"
          for env in dev staging prod; do
            if argocd app get app-only-${env} &>/dev/null; then
              argocd app get app-only-${env} --refresh || true
            fi
          done

          sleep 20

          for env in dev staging prod; do
            if argocd app get app-only-${env} &>/dev/null; then
              for i in 1 2 3; do
                argocd app sync app-only-${env} --timeout 120 && break
                echo "Sync retry $i/3 for ${env}..."
                sleep 10
              done
            fi
          done

          echo "✓ Sync triggered"

      # =========================================================================
      # PHASE 6: HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: Final Health Check"
        run: |
          echo "=== Final Health Check ==="

          echo ""
          echo "--- ArgoCD Applications ---"
          argocd app list

          echo ""
          echo "--- All Cluster Resources ---"
          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "=== Resources in ${NAMESPACE} ==="
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"
          done

          echo ""
          echo "=== APP-ONLY SCOPE TEST COMPLETED ==="

      # =========================================================================
      # CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="
          kind delete cluster --name e2e-app-only || true
          git push origin --delete "${BRANCH_NAME}" || true
          echo "✓ Cleanup complete"

  # ===========================================================================
  # NAMESPACE-SCOPE: Complete GitOps Flow (Namespace-Scoped ArgoCD)
  # ===========================================================================
  # Namespace-scope tests ArgoCD in namespace-scoped mode:
  # - ArgoCD can only manage resources in specific namespaces
  # - Tests namespace isolation and permissions
  # - Three environments (dev, staging, prod)
  # ===========================================================================
  namespace-scope-flow:
    name: Namespace-Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'namespace-scope' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-ns-scope-${{ github.run_id }}
      PROJECT_NAME: test-namespace-scope
      CONFIG_FILE: namespace-scope-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable and preserve
        run: |
          chmod +x bin/gitopsi
          # Copy binary to /tmp to preserve it across git operations
          cp bin/gitopsi /tmp/gitopsi

      # =========================================================================
      # PHASE 1: SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Kind Cluster"
        run: |
          echo "=== Creating Kind Cluster ==="
          kind create cluster --name e2e-ns-scope --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
          echo "✓ Cluster created"
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GENERATE & PUSH
      # =========================================================================
      - name: "Phase 2: Generate Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Manifests (Namespace-Scope) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type d | sort

          echo ""
          echo "=== Verifying Namespace-Scope Structure ==="
          # Verify all 3 environment overlays
          for env in dev staging prod; do
            if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure/overlays/${env}" ]; then
              echo "✓ infrastructure/overlays/${env}/ exists"
            else
              echo "○ Missing infrastructure/overlays/${env}/"
            fi
          done

          # Check ArgoCD configuration
          if [ -d "/tmp/output/${PROJECT_NAME}/argocd" ]; then
            echo "✓ argocd/ exists"
            ls -la /tmp/output/${PROJECT_NAME}/argocd/
          fi

          echo ""
          echo "=== All YAML files ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E namespace-scope manifests (dev, staging, prod)"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: BOOTSTRAP ARGOCD
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD ==="
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          /tmp/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      - name: "Phase 3: Verify Namespace-Scoped Mode"
        run: |
          echo "=== Verifying Namespace-Scope Mode ==="

          # Check ArgoCD pods
          echo "ArgoCD Pods:"
          kubectl get pods -n argocd

          # Check if ArgoCD is configured in namespace-scope mode
          echo ""
          echo "ArgoCD Config:"
          kubectl get configmap argocd-cmd-params-cm -n argocd -o yaml 2>/dev/null | grep -A 5 "data:" || echo "Default config"

          echo "✓ Namespace-scope mode verified"

      # =========================================================================
      # PHASE 4: SYNC & VALIDATE ALL ENVIRONMENTS
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Project and Apps"
        run: |
          echo "=== Creating ArgoCD Project and Applications ==="

          # Create project
          argocd proj create ns-scope-test \
            --description "Namespace-scope test (dev, staging, prod)" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Create apps for all 3 environments
          for env in dev staging prod; do
            echo ""
            echo "--- Creating apps for ${env} ---"

            # Infrastructure app
            argocd app create ns-scope-infra-${env} \
              --project ns-scope-test \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "infrastructure/overlays/${env}" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace ${PROJECT_NAME}-${env} \
              --sync-policy automated \
              --auto-prune \
              --self-heal \
              --upsert

            # Applications app (if overlay exists)
            if [ -d "applications/overlays/${env}" ] 2>/dev/null || [ -d "/tmp/output/${PROJECT_NAME}/applications/overlays/${env}" ]; then
              argocd app create ns-scope-apps-${env} \
                --project ns-scope-test \
                --repo https://github.com/${{ github.repository }}.git \
                --revision "${BRANCH_NAME}" \
                --path "applications/overlays/${env}" \
                --dest-server https://kubernetes.default.svc \
                --dest-namespace ${PROJECT_NAME}-${env} \
                --sync-policy automated \
                --auto-prune \
                --self-heal \
                --upsert || echo "No apps overlay for ${env}"
            fi
          done

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync All Environments"
        run: |
          echo "=== Syncing All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "--- Syncing ${env} ---"

            # Sync infrastructure
            for i in 1 2 3; do
              argocd app sync ns-scope-infra-${env} --timeout 180 && break
              echo "Sync retry $i/3..."
              sleep 10
            done
            argocd app wait ns-scope-infra-${env} --sync --timeout 120 || true

            # Sync apps if exists
            if argocd app get ns-scope-apps-${env} &>/dev/null; then
              for i in 1 2 3; do
                argocd app sync ns-scope-apps-${env} --timeout 180 && break
                echo "Sync retry $i/3..."
                sleep 10
              done
              argocd app wait ns-scope-apps-${env} --sync --timeout 120 || true
            fi
          done

          sleep 30
          echo "✓ All environments synced"

      - name: "Phase 4: Validate All Environments"
        run: |
          echo "=== Validating All Environments ==="

          for env in dev staging prod; do
            echo ""
            echo "=========================================="
            echo "Validating ${env} environment"
            echo "=========================================="

            NAMESPACE="${PROJECT_NAME}-${env}"

            echo ""
            echo "--- Namespace Check ---"
            kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace ${NAMESPACE} exists" || {
              echo "Namespace not found"
              continue
            }

            echo ""
            echo "--- Infrastructure Resources ---"
            echo "RBAC:"
            kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RoleBindings found" || echo "No RoleBindings"

            echo "NetworkPolicies:"
            kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies found" || echo "No NetworkPolicies"

            echo "ResourceQuotas:"
            kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas found" || echo "No ResourceQuotas"

            echo ""
            echo "--- All Resources ---"
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || true
          done

          echo ""
          echo "--- ArgoCD Application Status ---"
          argocd app list

          echo "✓ All environments validated"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS
      # =========================================================================
      - name: "Phase 5: Make Environment-Specific Changes"
        run: |
          echo "=== Making Day-2 Changes ==="

          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Add namespace-scope labels to each namespace
          for env in dev staging prod; do
            if [ -f "infrastructure/base/namespaces/${env}.yaml" ]; then
              echo "Modifying ${env} namespace..."
              yq eval ".metadata.labels[\"environment\"] = \"${env}\"" -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["e2e-test"] = "ns-scope-day2"' -i infrastructure/base/namespaces/${env}.yaml
              yq eval '.metadata.labels["argocd-mode"] = "namespace-scoped"' -i infrastructure/base/namespaces/${env}.yaml
              echo "Modified ${env}:"
              cat infrastructure/base/namespaces/${env}.yaml
              echo ""
            fi
          done

          echo "✓ Changes prepared"

      - name: "Phase 5: Push and Sync Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add namespace-scope labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          fi

          # Refresh and sync all apps
          echo ""
          echo "--- Syncing all apps ---"
          for env in dev staging prod; do
            argocd app get ns-scope-infra-${env} --refresh || true
          done

          sleep 20

          for env in dev staging prod; do
            for i in 1 2 3; do
              argocd app sync ns-scope-infra-${env} --timeout 120 && break
              echo "Sync retry $i/3 for ${env}..."
              sleep 10
            done
          done

          echo "✓ Sync triggered"

      - name: "Phase 5: Validate Changes Applied"
        run: |
          echo "=== Validating Changes Applied ==="

          sleep 15

          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "--- Checking ${env} labels ---"

            LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.argocd-mode}' 2>/dev/null || echo "")
            if [ "${LABEL}" = "namespace-scoped" ]; then
              echo "✓ ArgoCD-mode=namespace-scoped label found on ${env} namespace!"
            else
              echo "Label not yet applied to ${env}"
              kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' 2>/dev/null | jq . || true
            fi
          done

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: Final Health Check"
        run: |
          echo "=== Final Health Check ==="

          echo ""
          echo "--- ArgoCD Applications ---"
          argocd app list

          echo ""
          echo "--- Detailed Status per Environment ---"
          for env in dev staging prod; do
            echo ""
            echo "=== ${env} ==="
            argocd app get ns-scope-infra-${env} --show-operation 2>/dev/null || true
          done

          echo ""
          echo "--- All Cluster Resources ---"
          for env in dev staging prod; do
            NAMESPACE="${PROJECT_NAME}-${env}"
            echo ""
            echo "=== Resources in ${NAMESPACE} ==="
            kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"
          done

          echo ""
          echo "=== NAMESPACE-SCOPE TEST COMPLETED ==="

      # =========================================================================
      # CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="
          kind delete cluster --name e2e-ns-scope || true
          git push origin --delete "${BRANCH_NAME}" || true
          echo "✓ Cleanup complete"

  # ===========================================================================
  # MULTI-CLUSTER TEST: Complete Multi-Cluster GitOps Flow
  # ===========================================================================
  # This test validates the full multi-cluster GitOps workflow:
  # 1. Create multiple Kind clusters (hub + workload clusters)
  # 2. Generate multi-cluster manifests with gitopsi
  # 3. Bootstrap ArgoCD on hub cluster
  # 4. Register workload clusters with ArgoCD
  # 5. Deploy hello-world app to both clusters
  # 6. Validate deployments and make config changes
  # 7. Verify ArgoCD syncs changes to all clusters
  # ===========================================================================
  multi-cluster-complete:
    name: Multi-Cluster - Complete GitOps Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'multi-cluster' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-mc-${{ github.run_id }}
      PROJECT_NAME: mc-gitops
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      # =========================================================================
      # PHASE 1: INFRASTRUCTURE SETUP
      # =========================================================================
      - name: "Phase 1: Install Tools"
        run: |
          echo "=== Installing Tools ==="
          # Install kind
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          # Install ArgoCD CLI
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

          echo "✓ Tools installed"

      - name: "Phase 1: Create Hub Cluster (nonprod)"
        run: |
          echo "=== Creating Hub Cluster (nonprod) ==="
          kind create cluster --name mc-hub --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info

          # Save hub cluster context
          echo "HUB_CONTEXT=kind-mc-hub" >> $GITHUB_ENV

          echo "✓ Hub cluster (nonprod) created"
        timeout-minutes: 3

      - name: "Phase 1: Create Workload Cluster (prod)"
        run: |
          echo "=== Creating Workload Cluster (prod) ==="
          kind create cluster --name mc-prod --wait 120s
          kubectl wait --for=condition=Ready nodes --all --timeout=120s

          # Get prod cluster API server URL
          PROD_API=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-mc-prod")].cluster.server}')
          echo "PROD_API=${PROD_API}" >> $GITHUB_ENV
          echo "PROD_CONTEXT=kind-mc-prod" >> $GITHUB_ENV

          # Switch back to hub cluster
          kubectl config use-context kind-mc-hub

          echo "✓ Workload cluster (prod) created"
          echo "Available contexts:"
          kubectl config get-contexts
        timeout-minutes: 3

      # =========================================================================
      # PHASE 2: GITOPSI GENERATION
      # =========================================================================
      - name: "Phase 2: Generate Multi-Cluster Manifests"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Generating Multi-Cluster Manifests ==="

          # Create config with actual cluster URLs
          cat > /tmp/mc-config.yaml <<EOF
          project:
            name: ${PROJECT_NAME}
            description: Multi-cluster GitOps E2E test

          platform: kubernetes
          scope: both
          gitops_tool: argocd
          preset: standard
          topology: cluster-per-env

          environments:
            - name: nonprod
              cluster: https://kubernetes.default.svc
            - name: prod
              cluster: ${PROD_API}

          infra:
            namespaces: true
            rbac: true
            network_policies: true
            resource_quotas: true

          docs:
            readme: true
            architecture: true
            onboarding: true

          git:
            url: https://github.com/${{ github.repository }}.git

          output:
            type: local
          EOF

          echo "Config file:"
          cat /tmp/mc-config.yaml

          # Generate manifests
          ./bin/gitopsi init \
            --config /tmp/mc-config.yaml \
            --output /tmp/output \
            --git-url https://github.com/${{ github.repository }}.git \
            --verbose

          echo ""
          echo "=== Generated Structure ==="
          find /tmp/output/${PROJECT_NAME} -type f -name "*.yaml" | sort

          echo ""
          echo "=== ArgoCD Configuration ==="
          ls -la /tmp/output/${PROJECT_NAME}/argocd/ || true
          ls -la /tmp/output/${PROJECT_NAME}/argocd/projects/ || true
          ls -la /tmp/output/${PROJECT_NAME}/argocd/applicationsets/ || true

          echo "✓ Manifests generated"

      - name: "Phase 2: Push to Git"
        run: |
          echo "=== Pushing to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E multi-cluster manifests for nonprod and prod"
          git push origin "${BRANCH_NAME}"

          echo "✓ Pushed to branch: ${BRANCH_NAME}"

      # =========================================================================
      # PHASE 3: ARGOCD BOOTSTRAP ON HUB CLUSTER
      # =========================================================================
      - name: "Phase 3: Bootstrap ArgoCD on Hub Cluster"
        env:
          GITOPSI_GIT_BRANCH: ${{ env.BRANCH_NAME }}
        run: |
          echo "=== Bootstrapping ArgoCD on Hub Cluster ==="
          kubectl config use-context kind-mc-hub

          # Restore fixtures for bootstrap
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          # Bootstrap ArgoCD using helm
          /tmp/gitopsi init \
            --config /tmp/mc-config.yaml \
            --output /tmp/bootstrap \
            --git-url https://github.com/${{ github.repository }}.git \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose

          echo "✓ ArgoCD bootstrapped"
        timeout-minutes: 8

      - name: "Phase 3: Wait for ArgoCD Ready"
        run: |
          echo "=== Waiting for ArgoCD ==="
          kubectl config use-context kind-mc-hub

          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          kubectl wait --for=condition=available deployment/argocd-repo-server -n argocd --timeout=300s
          kubectl wait --for=condition=available deployment/argocd-applicationset-controller -n argocd --timeout=300s

          echo ""
          echo "ArgoCD pods:"
          kubectl get pods -n argocd

          echo "✓ ArgoCD is ready"

      - name: "Phase 3: Configure ArgoCD Access"
        run: |
          echo "=== Configuring ArgoCD Access ==="

          # Get admin password
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          echo "ARGOCD_PASSWORD=${PASSWORD}" >> $GITHUB_ENV

          # Port forward
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          # Login
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "✓ ArgoCD login successful"

      - name: "Phase 3: Verify ArgoCD Configuration"
        run: |
          echo "=== Verifying ArgoCD Configuration ==="

          echo ""
          echo "--- Registered Clusters ---"
          argocd cluster list

          echo ""
          echo "--- Repositories ---"
          argocd repo list || echo "No repos configured yet"

          echo ""
          echo "--- Projects ---"
          argocd proj list || echo "No projects yet"

          echo "✓ ArgoCD configuration verified"

      - name: "Phase 3: Register Prod Cluster with ArgoCD"
        run: |
          echo "=== Registering Prod Cluster with ArgoCD ==="

          # Register the prod cluster
          argocd cluster add kind-mc-prod --yes --name prod-cluster || {
            echo "Direct cluster add failed, trying with service account..."

            # Get prod cluster credentials
            kubectl config use-context kind-mc-prod

            # Create service account for ArgoCD
            kubectl create namespace argocd-manager || true
            kubectl create serviceaccount argocd-manager -n argocd-manager || true
            kubectl create clusterrolebinding argocd-manager --clusterrole=cluster-admin --serviceaccount=argocd-manager:argocd-manager || true

            # Switch back to hub
            kubectl config use-context kind-mc-hub
            echo "Service account created on prod cluster"
          }

          echo ""
          echo "--- All Registered Clusters ---"
          argocd cluster list

          echo "✓ Prod cluster registered"

      # =========================================================================
      # PHASE 4: INITIAL SYNC & VALIDATION
      # =========================================================================
      - name: "Phase 4: Create ArgoCD Applications"
        run: |
          echo "=== Creating ArgoCD Applications ==="

          # Create ArgoCD Project
          argocd proj create multi-cluster \
            --description "Multi-cluster GitOps project" \
            --src https://github.com/${{ github.repository }}.git \
            --dest '*,*' \
            --upsert || true

          # Application for nonprod (hub cluster)
          echo "Creating nonprod infrastructure app..."
          argocd app create mc-infra-nonprod \
            --project multi-cluster \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/nonprod" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace nonprod \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert

          # Application for nonprod apps
          echo "Creating nonprod applications app..."
          argocd app create mc-apps-nonprod \
            --project multi-cluster \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "applications/overlays/nonprod" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace ${PROJECT_NAME}-nonprod \
            --sync-policy automated \
            --auto-prune \
            --self-heal \
            --upsert

          echo ""
          echo "--- All Applications ---"
          argocd app list

          echo "✓ Applications created"

      - name: "Phase 4: Sync NonProd and Validate"
        run: |
          echo "=== Syncing NonProd ==="

          # Sync infrastructure
          for i in 1 2 3; do
            argocd app sync mc-infra-nonprod --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          # Wait for sync
          argocd app wait mc-infra-nonprod --sync --timeout 120 || true

          echo ""
          echo "--- NonProd Infrastructure Status ---"
          argocd app get mc-infra-nonprod

          # Sync applications
          for i in 1 2 3; do
            argocd app sync mc-apps-nonprod --timeout 180 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          argocd app wait mc-apps-nonprod --sync --timeout 120 || true

          echo ""
          echo "--- NonProd Applications Status ---"
          argocd app get mc-apps-nonprod

          echo "✓ NonProd synced"

      - name: "Phase 4: Validate NonProd Deployment"
        run: |
          echo "=== Validating NonProd Deployment ==="
          kubectl config use-context kind-mc-hub

          sleep 30  # Wait for resources to be created

          NAMESPACE="${PROJECT_NAME}-nonprod"

          echo ""
          echo "--- Checking Namespace ---"
          kubectl get namespace "${NAMESPACE}" && echo "✓ Namespace exists" || {
            echo "Namespace not found, checking all namespaces:"
            kubectl get namespaces
          }

          echo ""
          echo "--- Checking Infrastructure Resources ---"
          kubectl get rolebindings -n "${NAMESPACE}" 2>/dev/null && echo "✓ RBAC configured" || true
          kubectl get networkpolicies -n "${NAMESPACE}" 2>/dev/null && echo "✓ NetworkPolicies configured" || true
          kubectl get resourcequotas -n "${NAMESPACE}" 2>/dev/null && echo "✓ ResourceQuotas configured" || true

          echo ""
          echo "--- Checking Hello-World App ---"
          kubectl get deployments -n "${NAMESPACE}" 2>/dev/null || true
          kubectl get services -n "${NAMESPACE}" 2>/dev/null || true
          kubectl get pods -n "${NAMESPACE}" 2>/dev/null || true

          echo "✓ NonProd validation complete"

      # =========================================================================
      # PHASE 5: DAY-2 OPERATIONS (Config Change)
      # =========================================================================
      - name: "Phase 5: Make Environment-Specific Changes"
        run: |
          echo "=== Making Environment-Specific Changes ==="

          # Restore git state
          git fetch origin "${BRANCH_NAME}"
          git checkout "${BRANCH_NAME}"
          git pull origin "${BRANCH_NAME}"

          # Modify nonprod config (add label)
          if [ -f "infrastructure/base/namespaces/nonprod.yaml" ]; then
            echo "Modifying nonprod namespace..."
            yq eval '.metadata.labels["environment"] = "nonprod"' -i infrastructure/base/namespaces/nonprod.yaml
            yq eval '.metadata.labels["e2e-test"] = "day2-change"' -i infrastructure/base/namespaces/nonprod.yaml
            cat infrastructure/base/namespaces/nonprod.yaml
          fi

          # Modify prod config (different label)
          if [ -f "infrastructure/base/namespaces/prod.yaml" ]; then
            echo "Modifying prod namespace..."
            yq eval '.metadata.labels["environment"] = "prod"' -i infrastructure/base/namespaces/prod.yaml
            yq eval '.metadata.labels["e2e-test"] = "day2-change"' -i infrastructure/base/namespaces/prod.yaml
            cat infrastructure/base/namespaces/prod.yaml
          fi

          echo "✓ Changes prepared"

      - name: "Phase 5: Push Changes"
        run: |
          echo "=== Pushing Changes ==="

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Day-2: Add environment-specific labels"
            git push origin "${BRANCH_NAME}"
            echo "✓ Changes pushed"
          else
            echo "No changes to push"
          fi

      - name: "Phase 5: Verify ArgoCD Syncs Changes"
        run: |
          echo "=== Verifying ArgoCD Syncs Changes ==="

          # Refresh apps
          argocd app get mc-infra-nonprod --refresh || true
          sleep 30

          # Sync
          for i in 1 2 3; do
            argocd app sync mc-infra-nonprod --timeout 120 && break
            echo "Sync retry $i/3..."
            sleep 10
          done

          echo ""
          echo "--- App Status After Change ---"
          argocd app get mc-infra-nonprod

          echo "✓ Changes synced"

      - name: "Phase 5: Validate Changes Applied"
        run: |
          echo "=== Validating Changes Applied ==="
          kubectl config use-context kind-mc-hub

          NAMESPACE="${PROJECT_NAME}-nonprod"

          # Check labels
          echo ""
          echo "--- Namespace Labels ---"
          kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels}' 2>/dev/null | jq . || {
            kubectl get namespace "${NAMESPACE}" -o yaml | grep -A 10 "labels:"
          }

          LABEL=$(kubectl get namespace "${NAMESPACE}" -o jsonpath='{.metadata.labels.e2e-test}' 2>/dev/null || echo "")
          if [ "${LABEL}" = "day2-change" ]; then
            echo "✓ Day-2 change label found!"
          else
            echo "Label not found yet (may still be syncing)"
          fi

          echo "✓ Change validation complete"

      # =========================================================================
      # PHASE 6: COMPLETE HEALTH CHECK
      # =========================================================================
      - name: "Phase 6: ArgoCD Health Check"
        run: |
          echo "=== ArgoCD Complete Health Check ==="

          echo ""
          echo "--- All Applications Status ---"
          argocd app list

          echo ""
          echo "--- Detailed App Status ---"
          for app in $(argocd app list -o name 2>/dev/null); do
            echo ""
            echo "=== ${app} ==="
            argocd app get "${app}" --show-operation 2>/dev/null || true
          done

          echo ""
          echo "--- Clusters Health ---"
          argocd cluster list

          echo ""
          echo "--- Projects ---"
          argocd proj list

          echo "✓ Health check complete"

      - name: "Phase 6: Cluster Resource Validation"
        run: |
          echo "=== Cluster Resource Validation ==="

          echo ""
          echo "--- Hub Cluster (NonProd) Resources ---"
          kubectl config use-context kind-mc-hub
          NAMESPACE="${PROJECT_NAME}-nonprod"

          echo "Namespaces:"
          kubectl get namespaces | grep -E "^${PROJECT_NAME}|^argocd"

          echo ""
          echo "Resources in ${NAMESPACE}:"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist"

          echo ""
          echo "--- Prod Cluster Resources ---"
          kubectl config use-context kind-mc-prod
          NAMESPACE="${PROJECT_NAME}-prod"

          echo "Namespaces:"
          kubectl get namespaces | grep -E "^${PROJECT_NAME}" || echo "No project namespaces on prod yet"

          echo ""
          echo "Resources in ${NAMESPACE}:"
          kubectl get all -n "${NAMESPACE}" 2>/dev/null || echo "Namespace may not exist on prod"

          # Switch back to hub
          kubectl config use-context kind-mc-hub

          echo "✓ Resource validation complete"

      - name: "Phase 6: Generate Test Report"
        run: |
          echo "=== Multi-Cluster E2E Test Report ==="
          echo ""
          echo "## Test Configuration"
          echo "- Project: ${PROJECT_NAME}"
          echo "- Branch: ${BRANCH_NAME}"
          echo "- Hub Cluster: kind-mc-hub (nonprod)"
          echo "- Workload Cluster: kind-mc-prod (prod)"
          echo ""
          echo "## Validation Results"
          echo ""
          echo "### Phase 1: Infrastructure Setup"
          echo "✓ Tools installed (kind, argocd, kustomize)"
          echo "✓ Hub cluster created"
          echo "✓ Prod cluster created"
          echo ""
          echo "### Phase 2: GitOps Generation"
          echo "✓ Multi-cluster manifests generated"
          echo "✓ Pushed to test branch"
          echo ""
          echo "### Phase 3: ArgoCD Bootstrap"
          echo "✓ ArgoCD deployed on hub cluster"
          echo "✓ Prod cluster registered"
          echo ""
          echo "### Phase 4: Initial Sync"
          echo "✓ Applications created"
          echo "✓ NonProd infrastructure synced"
          echo "✓ NonProd apps synced"
          echo ""
          echo "### Phase 5: Day-2 Operations"
          echo "✓ Environment-specific changes made"
          echo "✓ Changes pushed to git"
          echo "✓ ArgoCD synced changes"
          echo ""
          echo "### Phase 6: Health Check"
          echo "✓ All apps healthy"
          echo "✓ Clusters connected"
          echo ""
          echo "=== MULTI-CLUSTER E2E TEST COMPLETED SUCCESSFULLY ==="

      # =========================================================================
      # PHASE 7: CLEANUP
      # =========================================================================
      - name: "Cleanup"
        if: always()
        run: |
          echo "=== Cleanup ==="

          # Delete clusters
          kind delete cluster --name mc-hub || true
          kind delete cluster --name mc-prod || true

          # Delete test branch
          git push origin --delete "${BRANCH_NAME}" || true

          echo "✓ Cleanup complete"

  # ===========================================================================
  # Marketplace Tests
  # ===========================================================================
  marketplace-tests:
    name: Marketplace Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'marketplace' || github.event.inputs.test_suite == '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Test marketplace commands
        run: |
          ./bin/gitopsi marketplace list || echo "List completed"
          ./bin/gitopsi marketplace categories || echo "Categories listed"
          ./bin/gitopsi marketplace search monitoring || echo "Search completed"
          ./bin/gitopsi marketplace info prometheus || echo "Info retrieved"

      - name: Generate project and test pattern install
        run: |
          ./bin/gitopsi init --config test/e2e/fixtures/standard-config.yaml --output /tmp/project --git-url https://github.com/${{ github.repository }}.git --verbose
          ./bin/gitopsi marketplace validate prometheus --project /tmp/project/test-standard || echo "Validation completed"

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  summary-report:
    name: Summary Report
    needs:
      - build
      - minimal-preset-flow
      - standard-preset-flow
      - enterprise-preset-flow
      - infra-only-flow
      - app-only-flow
      - namespace-scope-flow
      - multi-cluster-complete
      - marketplace-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "# E2E Test Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.build.outputs.commit }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Complete Flow Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Flow | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} | Binary compilation |" >> $GITHUB_STEP_SUMMARY
          echo "| Minimal Preset | ${{ needs.minimal-preset-flow.result == 'success' && '✅' || (needs.minimal-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: namespace only |" >> $GITHUB_STEP_SUMMARY
          echo "| Standard Preset | ${{ needs.standard-preset-flow.result == 'success' && '✅' || (needs.standard-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: full infra |" >> $GITHUB_STEP_SUMMARY
          echo "| Enterprise Preset | ${{ needs.enterprise-preset-flow.result == 'success' && '✅' || (needs.enterprise-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: enterprise features |" >> $GITHUB_STEP_SUMMARY
          echo "| Infra-Only Scope | ${{ needs.infra-only-flow.result == 'success' && '✅' || (needs.infra-only-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: no applications |" >> $GITHUB_STEP_SUMMARY
          echo "| App-Only Scope | ${{ needs.app-only-flow.result == 'success' && '✅' || (needs.app-only-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: apps only |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace-Scope | ${{ needs.namespace-scope-flow.result == 'success' && '✅' || (needs.namespace-scope-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: ns-scoped ArgoCD |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-Cluster | ${{ needs.multi-cluster-complete.result == 'success' && '✅' || (needs.multi-cluster-complete.result == 'skipped' && '⏭️' || '❌') }} | Complete multi-cluster GitOps flow |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketplace | ${{ needs.marketplace-tests.result == 'success' && '✅' || (needs.marketplace-tests.result == 'skipped' && '⏭️' || '❌') }} | Pattern management |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Multi-Cluster Test Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The multi-cluster test validates the complete GitOps workflow:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Create Hub cluster (nonprod) and Workload cluster (prod)" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Generate multi-cluster manifests with gitopsi" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Push manifests to Git" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Bootstrap ArgoCD on Hub cluster" >> $GITHUB_STEP_SUMMARY
          echo "5. ✅ Register Prod cluster with ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "6. ✅ Create ArgoCD Applications for both clusters" >> $GITHUB_STEP_SUMMARY
          echo "7. ✅ Sync and validate infrastructure on both clusters" >> $GITHUB_STEP_SUMMARY
          echo "8. ✅ Deploy hello-world app to both environments" >> $GITHUB_STEP_SUMMARY
          echo "9. ✅ Make Day-2 config changes per environment" >> $GITHUB_STEP_SUMMARY
          echo "10. ✅ Verify ArgoCD syncs changes to all clusters" >> $GITHUB_STEP_SUMMARY
          echo "11. ✅ Complete health check of all resources" >> $GITHUB_STEP_SUMMARY
          echo "12. ✅ Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Standard 12-Step Flow" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each preset/scope test validates:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Generate manifests with gitopsi" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Create Kind cluster" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Push to Git" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Bootstrap ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "5. ✅ Configure ArgoCD to sync from Git" >> $GITHUB_STEP_SUMMARY
          echo "6. ✅ Verify initial sync" >> $GITHUB_STEP_SUMMARY
          echo "7. ✅ Validate resources on cluster" >> $GITHUB_STEP_SUMMARY
          echo "8. ✅ Make code changes" >> $GITHUB_STEP_SUMMARY
          echo "9. ✅ Push changes to Git" >> $GITHUB_STEP_SUMMARY
          echo "10. ✅ Verify ArgoCD syncs changes" >> $GITHUB_STEP_SUMMARY
          echo "11. ✅ Validate changes applied on cluster" >> $GITHUB_STEP_SUMMARY
          echo "12. ✅ Cleanup" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          FAILED=false
          [ "${{ needs.build.result }}" != "success" ] && FAILED=true
          [ "${{ needs.minimal-preset-flow.result }}" != "success" ] && [ "${{ needs.minimal-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.standard-preset-flow.result }}" != "success" ] && [ "${{ needs.standard-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.enterprise-preset-flow.result }}" != "success" ] && [ "${{ needs.enterprise-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.infra-only-flow.result }}" != "success" ] && [ "${{ needs.infra-only-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.app-only-flow.result }}" != "success" ] && [ "${{ needs.app-only-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.namespace-scope-flow.result }}" != "success" ] && [ "${{ needs.namespace-scope-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.multi-cluster-complete.result }}" != "success" ] && [ "${{ needs.multi-cluster-complete.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.marketplace-tests.result }}" != "success" ] && [ "${{ needs.marketplace-tests.result }}" != "skipped" ] && FAILED=true

          if [ "$FAILED" = "true" ]; then
            echo "::error::One or more test flows failed"
            exit 1
          fi
          echo "✅ All E2E tests passed!"

  # ===========================================================================
  # Report Failure
  # ===========================================================================
  report-failure:
    name: Report Failure
    needs:
      - build
      - minimal-preset-flow
      - standard-preset-flow
      - enterprise-preset-flow
      - infra-only-flow
      - app-only-flow
      - namespace-scope-flow
      - multi-cluster-complete
      - marketplace-tests
      - summary-report
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Check for existing issue
        id: check
        run: |
          EXISTING=$(gh issue list --repo ${{ github.repository }} --search "E2E Test Failure" --state open --json number --jq 'length')
          echo "exists=$( [ \"${EXISTING}\" -gt \"0\" ] && echo true || echo false )" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create failure issue
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat <<EOF > /tmp/issue_body.md
          ## E2E Test Failure

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Version**: ${{ needs.build.outputs.version }}
          **Commit**: ${{ needs.build.outputs.commit }}

          ### Test Results
          | Test Flow | Status |
          |-----------|--------|
          | Build | ${{ needs.build.result }} |
          | Minimal Preset | ${{ needs.minimal-preset-flow.result }} |
          | Standard Preset | ${{ needs.standard-preset-flow.result }} |
          | Enterprise Preset | ${{ needs.enterprise-preset-flow.result }} |
          | Infra-Only | ${{ needs.infra-only-flow.result }} |
          | App-Only | ${{ needs.app-only-flow.result }} |
          | Namespace-Scope | ${{ needs.namespace-scope-flow.result }} |
          | Multi-Cluster | ${{ needs.multi-cluster-complete.result }} |
          | Marketplace | ${{ needs.marketplace-tests.result }} |

          ### Next Steps
          1. Check the failed job logs
          2. Reproduce locally with kind cluster
          3. Fix the issue and re-run
          EOF

          gh issue create \
            --repo ${{ github.repository }} \
            --title "E2E Test Failure: ${{ needs.build.outputs.version }}" \
            --body-file /tmp/issue_body.md
