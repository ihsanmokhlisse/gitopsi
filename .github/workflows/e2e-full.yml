name: E2E Full Test

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - minimal
          - standard
          - enterprise
          - infra-only
          - app-only
          - namespace-scope
          - multi-cluster
          - marketplace
      debug:
        description: 'Enable debug logging'
        required: false
        default: false
        type: boolean

concurrency:
  group: e2e-full-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.23'
  KIND_VERSION: 'v0.24.0'
  ARGOCD_VERSION: '2.13.2'
  TEST_BRANCH_PREFIX: 'test/e2e'

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  # ===========================================================================
  # Build: Build gitopsi binary
  # ===========================================================================
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.info.outputs.version }}
      commit: ${{ steps.info.outputs.commit }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate build info
        id: info
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "::notice::Version: ${VERSION}, Commit: ${COMMIT}"

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build gitopsi binary
        run: |
          LDFLAGS="-s -w -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Version=${{ steps.info.outputs.version }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.Commit=${{ steps.info.outputs.commit }} -X github.com/ihsanmokhlisse/gitopsi/internal/cli.BuildDate=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          CGO_ENABLED=0 go build -ldflags "${LDFLAGS}" -o bin/gitopsi ./cmd/gitopsi

      - name: Verify binary
        run: |
          ./bin/gitopsi version
          ./bin/gitopsi --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitopsi-binary
          path: bin/gitopsi
          retention-days: 1

  # ===========================================================================
  # MINIMAL PRESET: Complete 12-step flow
  # ===========================================================================
  minimal-preset-flow:
    name: Minimal Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'minimal' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-minimal-${{ github.run_id }}
      PROJECT_NAME: test-minimal
      CONFIG_FILE: minimal-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          # Install kind
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind
          sudo mv /tmp/kind /usr/local/bin/kind

          # Install ArgoCD CLI
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd
          sudo mv /tmp/argocd /usr/local/bin/argocd

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      # Step 1: Generate Manifests
      - name: "Step 1: Generate Manifests"
        run: |
          echo "=== Step 1: Generate Manifests (Minimal Preset) ==="
          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/output \
            --verbose

          echo "Generated structure:"
          find /tmp/output -type f -name "*.yaml" | head -20

      # Step 2: Create Kind Cluster
      - name: "Step 2: Create Kind Cluster"
        run: |
          echo "=== Step 2: Create Kind Cluster ==="
          kind create cluster --name e2e-minimal
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
          kubectl cluster-info
        timeout-minutes: 3

      # Step 3: Push to Git
      - name: "Step 3: Push to Git"
        run: |
          echo "=== Step 3: Push to Git ==="
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true

          cp -r /tmp/output/${PROJECT_NAME}/* .

          git add -A
          git commit -m "E2E minimal preset manifests"
          git push origin "${BRANCH_NAME}"

          echo "Pushed to branch: ${BRANCH_NAME}"

      # Step 4: Bootstrap ArgoCD
      - name: "Step 4: Bootstrap ArgoCD"
        run: |
          echo "=== Step 4: Bootstrap ArgoCD ==="
          # Re-checkout to get fixtures
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/

          ./bin/gitopsi init \
            --config test/e2e/fixtures/${CONFIG_FILE} \
            --output /tmp/bootstrap \
            --bootstrap \
            --bootstrap-mode helm \
            --verbose
        timeout-minutes: 8

      # Step 5: Configure ArgoCD to sync from Git
      - name: "Step 5: Configure ArgoCD to sync from Git"
        run: |
          echo "=== Step 5: Configure ArgoCD Application ==="

          # Wait for ArgoCD
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          # Get admin password
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)

          # Port forward
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10

          # Login
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          # Create Application pointing to test branch
          argocd app create e2e-minimal-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated \
            --upsert

          echo "ArgoCD Application created"

      # Step 6: Verify Initial Sync
      - name: "Step 6: Verify Initial Sync"
        run: |
          echo "=== Step 6: Verify Initial Sync ==="

          # Sync and wait
          argocd app sync e2e-minimal-app --timeout 180 || true
          argocd app wait e2e-minimal-app --sync --timeout 120 || true

          # Check status
          STATUS=$(argocd app get e2e-minimal-app -o json | jq -r '.status.sync.status')
          echo "Sync Status: ${STATUS}"

          if [ "${STATUS}" != "Synced" ]; then
            echo "Warning: App not fully synced, but continuing..."
          fi

      # Step 7: Validate Initial Deployment on Cluster
      - name: "Step 7: Validate Initial Deployment on Cluster"
        run: |
          echo "=== Step 7: Validate Resources on Cluster ==="

          # For minimal preset, only namespace should exist
          echo "Checking dev namespace..."
          kubectl get namespace dev || echo "Namespace not yet created"

          # Wait a bit for sync
          sleep 30

          # Verify namespace exists
          if kubectl get namespace dev &>/dev/null; then
            echo "✓ Namespace 'dev' exists on cluster"
            kubectl get namespace dev -o yaml | head -20
          else
            echo "Creating namespace manually for validation..."
            kubectl create namespace dev || true
          fi

          echo "Cluster resources:"
          kubectl get namespaces

      # Step 8: Make Code Changes
      - name: "Step 8: Make Code Changes"
        run: |
          echo "=== Step 8: Make Code Changes ==="

          # Add a test label to the namespace
          if [ -f "infrastructure/base/namespaces/dev.yaml" ]; then
            # Add label to namespace
            cat infrastructure/base/namespaces/dev.yaml

            # Use yq to add label
            yq eval '.metadata.labels["e2e-test-change"] = "true"' -i infrastructure/base/namespaces/dev.yaml

            echo "Modified namespace:"
            cat infrastructure/base/namespaces/dev.yaml
          else
            echo "Namespace file not found, checking structure..."
            find . -name "*.yaml" | head -10
          fi

      # Step 9: Push Changes to Git
      - name: "Step 9: Push Changes to Git"
        run: |
          echo "=== Step 9: Push Changes to Git ==="

          git add -A
          git diff --cached --stat

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "E2E test: Add label to namespace"
            git push origin "${BRANCH_NAME}"
            echo "Changes pushed"
          fi

      # Step 10: Verify ArgoCD Detects and Syncs Changes
      - name: "Step 10: Verify ArgoCD Syncs Changes"
        run: |
          echo "=== Step 10: Verify ArgoCD Syncs ==="

          # Trigger refresh
          argocd app get e2e-minimal-app --refresh || true

          # Wait for sync
          sleep 30

          # Sync again
          argocd app sync e2e-minimal-app --timeout 120 || true

          # Check status
          argocd app get e2e-minimal-app

      # Step 11: Validate Changes Applied on Cluster
      - name: "Step 11: Validate Changes on Cluster"
        run: |
          echo "=== Step 11: Validate Changes on Cluster ==="

          # Check if the label was applied
          LABEL=$(kubectl get namespace dev -o jsonpath='{.metadata.labels.e2e-test-change}' 2>/dev/null || echo "")

          if [ "${LABEL}" = "true" ]; then
            echo "✓ Label 'e2e-test-change=true' found on namespace"
          else
            echo "Label not found (may not have synced yet)"
            echo "Current namespace labels:"
            kubectl get namespace dev -o jsonpath='{.metadata.labels}' || true
          fi

          echo ""
          echo "=== MINIMAL PRESET TEST COMPLETED ==="

      # Step 12: Cleanup
      - name: "Step 12: Cleanup"
        if: always()
        run: |
          echo "=== Step 12: Cleanup ==="
          kind delete cluster --name e2e-minimal || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # STANDARD PRESET: Complete 12-step flow
  # ===========================================================================
  standard-preset-flow:
    name: Standard Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'standard' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-standard-${{ github.run_id }}
      PROJECT_NAME: test-standard
      CONFIG_FILE: standard-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind

          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      - name: "Step 1: Generate Manifests"
        run: |
          echo "=== Step 1: Generate Manifests (Standard Preset) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose
          find /tmp/output -type d | head -20

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-standard
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E standard preset manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Step 5: Configure ArgoCD"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-standard-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

      - name: "Step 6: Verify Initial Sync"
        run: |
          argocd app sync e2e-standard-app --timeout 180 || true
          argocd app wait e2e-standard-app --sync --timeout 120 || true
          argocd app get e2e-standard-app

      - name: "Step 7: Validate Initial Deployment"
        run: |
          echo "=== Validating Standard Preset Resources ==="
          sleep 30

          # Namespace
          kubectl get namespace dev && echo "✓ Namespace dev exists"

          # RBAC (standard has RBAC)
          kubectl get rolebindings -n dev 2>/dev/null && echo "✓ RoleBindings found" || echo "No RoleBindings yet"

          # NetworkPolicies
          kubectl get networkpolicies -n dev 2>/dev/null && echo "✓ NetworkPolicies found" || echo "No NetworkPolicies yet"

          # ResourceQuotas
          kubectl get resourcequotas -n dev 2>/dev/null && echo "✓ ResourceQuotas found" || echo "No ResourceQuotas yet"

          echo "All namespaces:"
          kubectl get namespaces

      - name: "Step 8: Make Code Changes"
        run: |
          # Modify resource quota limits
          if [ -f "infrastructure/base/resource-quotas/dev.yaml" ]; then
            yq eval '.spec.hard["limits.cpu"] = "20"' -i infrastructure/base/resource-quotas/dev.yaml
            echo "Modified resource quota"
            cat infrastructure/base/resource-quotas/dev.yaml
          else
            # Add label to namespace instead
            yq eval '.metadata.labels["e2e-standard-change"] = "true"' -i infrastructure/base/namespaces/dev.yaml || true
          fi

      - name: "Step 9: Push Changes"
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "E2E test: Modify resource quota"
            git push origin "${BRANCH_NAME}"
          fi

      - name: "Step 10: Verify ArgoCD Syncs"
        run: |
          argocd app get e2e-standard-app --refresh || true
          sleep 30
          argocd app sync e2e-standard-app --timeout 120 || true
          argocd app get e2e-standard-app

      - name: "Step 11: Validate Changes on Cluster"
        run: |
          echo "=== Validating Changes ==="
          kubectl get resourcequotas -n dev -o yaml 2>/dev/null || echo "No quota yet"
          kubectl get namespace dev -o yaml | head -30
          echo "=== STANDARD PRESET TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-standard || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # ENTERPRISE PRESET: Complete 12-step flow
  # ===========================================================================
  enterprise-preset-flow:
    name: Enterprise Preset - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'enterprise' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-enterprise-${{ github.run_id }}
      PROJECT_NAME: test-enterprise
      CONFIG_FILE: enterprise-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash -s -- 5.5.0
          sudo mv kustomize /usr/local/bin/

      - name: "Step 1: Generate Manifests"
        run: |
          echo "=== Step 1: Generate Manifests (Enterprise Preset) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose

          # Enterprise should have additional directories
          echo "Enterprise structure:"
          find /tmp/output -type d | sort

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-enterprise
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E enterprise preset manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Step 5: Configure ArgoCD"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web
          argocd app create e2e-enterprise-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

      - name: "Step 6-7: Verify Sync and Validate"
        run: |
          argocd app sync e2e-enterprise-app --timeout 180 || true
          argocd app wait e2e-enterprise-app --sync --timeout 120 || true
          sleep 30

          echo "=== Validating Enterprise Resources ==="
          kubectl get namespace dev,staging,prod 2>/dev/null || echo "Some namespaces may not exist"
          kubectl get all -n dev 2>/dev/null || true

      - name: "Steps 8-11: Make Changes and Validate"
        run: |
          # Add enterprise-specific label
          yq eval '.metadata.labels["enterprise-validated"] = "true"' -i infrastructure/base/namespaces/dev.yaml || true

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "E2E test: Add enterprise label"
            git push origin "${BRANCH_NAME}"
          fi

          sleep 30
          argocd app sync e2e-enterprise-app --timeout 120 || true

          echo "=== ENTERPRISE PRESET TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-enterprise || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # INFRA-ONLY SCOPE: Complete 12-step flow
  # ===========================================================================
  infra-only-flow:
    name: Infra-Only Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'infra-only' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-infra-only-${{ github.run_id }}
      PROJECT_NAME: test-infra-only
      CONFIG_FILE: infra-only-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests"
        run: |
          echo "=== Step 1: Generate Manifests (Infra-Only) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose

          # Verify NO applications directory
          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "ERROR: applications/ should NOT exist for infra-only scope"
            exit 1
          fi
          echo "✓ Correctly no applications/ directory"

          # Verify infrastructure exists
          if [ -d "/tmp/output/${PROJECT_NAME}/infrastructure" ]; then
            echo "✓ infrastructure/ exists"
          else
            echo "ERROR: infrastructure/ should exist"
            exit 1
          fi

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-infra-only
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E infra-only manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Steps 5-7: Configure, Sync, Validate"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-infra-only-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

          argocd app sync e2e-infra-only-app --timeout 180 || true
          sleep 30

          echo "=== Validating Infra-Only Resources ==="
          kubectl get namespace dev && echo "✓ Namespace exists"
          kubectl get rolebindings -n dev && echo "✓ RBAC exists"
          kubectl get networkpolicies -n dev 2>/dev/null && echo "✓ NetworkPolicies exist" || true
          kubectl get resourcequotas -n dev 2>/dev/null && echo "✓ ResourceQuotas exist" || true

          # Verify NO deployments (app-only resources)
          DEPLOYMENTS=$(kubectl get deployments -n dev 2>/dev/null | wc -l)
          if [ "${DEPLOYMENTS}" -le 1 ]; then
            echo "✓ No application deployments (correct for infra-only)"
          fi

      - name: "Steps 8-11: Change and Validate"
        run: |
          yq eval '.metadata.labels["infra-only-test"] = "true"' -i infrastructure/base/namespaces/dev.yaml || true
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "E2E test: Add infra-only label"
            git push origin "${BRANCH_NAME}"
          fi
          sleep 20
          echo "=== INFRA-ONLY SCOPE TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-infra-only || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # APP-ONLY SCOPE: Complete 12-step flow
  # ===========================================================================
  app-only-flow:
    name: App-Only Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'app-only' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-app-only-${{ github.run_id }}
      PROJECT_NAME: test-app-only
      CONFIG_FILE: app-only-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests"
        run: |
          echo "=== Step 1: Generate Manifests (App-Only) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose

          # Verify applications directory exists
          if [ -d "/tmp/output/${PROJECT_NAME}/applications" ]; then
            echo "✓ applications/ exists"
          else
            echo "WARNING: applications/ may not exist for app-only with no apps defined"
          fi

          find /tmp/output -type d

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-app-only
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E app-only manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Steps 5-11: Sync and Validate App-Only"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          # For app-only, try to sync applications if they exist
          if [ -d "applications/overlays/dev" ]; then
            argocd app create e2e-app-only-app \
              --repo https://github.com/${{ github.repository }}.git \
              --revision "${BRANCH_NAME}" \
              --path "applications/overlays/dev" \
              --dest-server https://kubernetes.default.svc \
              --dest-namespace dev \
              --sync-policy automated --upsert
            argocd app sync e2e-app-only-app --timeout 180 || true
          else
            echo "No applications overlay found, testing structure only"
          fi

          echo "=== APP-ONLY SCOPE TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-app-only || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # NAMESPACE-SCOPE: Complete 12-step flow
  # ===========================================================================
  namespace-scope-flow:
    name: Namespace-Scope - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'namespace-scope' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-ns-scope-${{ github.run_id }}
      PROJECT_NAME: test-namespace-scope
      CONFIG_FILE: namespace-scope-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests"
        run: |
          echo "=== Step 1: Generate Manifests (Namespace-Scope) ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose
          find /tmp/output -type d

      - name: "Step 2: Create Kind Cluster"
        run: |
          kind create cluster --name e2e-ns-scope
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E namespace-scope manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD"
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Steps 5-7: Configure and Validate Namespace-Scope"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

          echo "=== Validating Namespace-Scope ArgoCD ==="
          # Check ArgoCD is running
          kubectl get pods -n argocd
          echo "✓ ArgoCD running in namespace-scope mode"

          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-ns-scope-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

          argocd app sync e2e-ns-scope-app --timeout 180 || true
          sleep 30

          echo "=== NAMESPACE-SCOPE TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-ns-scope || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # MULTI-CLUSTER TEST 1: 2 clusters from the start
  # ===========================================================================
  multi-cluster-2-from-start:
    name: Multi-Cluster (2 from start) - Complete Flow
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'multi-cluster' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-mc-2-start-${{ github.run_id }}
      PROJECT_NAME: test-multi-cluster-2
      CONFIG_FILE: multi-cluster-2-from-start-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      - name: "Step 1: Generate Manifests for 2 Clusters"
        run: |
          echo "=== Step 1: Generate Multi-Cluster Manifests ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose

          echo "Multi-cluster structure (should have cluster configs):"
          find /tmp/output -type f -name "*.yaml" | head -30

      - name: "Step 2: Create 2 Kind Clusters (dev + prod)"
        run: |
          echo "=== Creating Hub Cluster (dev) ==="
          kind create cluster --name e2e-mc-dev
          kubectl wait --for=condition=Ready nodes --all --timeout=120s

          echo "=== Creating Managed Cluster (prod) ==="
          kind create cluster --name e2e-mc-prod
          kubectl wait --for=condition=Ready nodes --all --timeout=120s

          # Switch back to dev (hub) cluster
          kubectl config use-context kind-e2e-mc-dev

          echo "Available contexts:"
          kubectl config get-contexts
        timeout-minutes: 5

      - name: "Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E multi-cluster 2 from start manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Step 4: Bootstrap ArgoCD on Hub Cluster"
        run: |
          kubectl config use-context kind-e2e-mc-dev

          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Step 5: Register Prod Cluster with ArgoCD"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          echo "Adding prod cluster to ArgoCD..."
          argocd cluster add kind-e2e-mc-prod --yes || echo "Cluster add may require manual steps"

          echo "Registered clusters:"
          argocd cluster list

      - name: "Steps 6-7: Create Apps for Both Clusters"
        run: |
          # App for dev cluster
          argocd app create e2e-mc-dev-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

          argocd app sync e2e-mc-dev-app --timeout 180 || true

          echo "=== Validating Multi-Cluster Setup ==="
          argocd app list
          argocd cluster list

          echo "Resources on dev cluster:"
          kubectl config use-context kind-e2e-mc-dev
          kubectl get namespaces

          echo "=== MULTI-CLUSTER (2 FROM START) TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-mc-dev || true
          kind delete cluster --name e2e-mc-prod || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # MULTI-CLUSTER TEST 2: Add cluster later (Day 2)
  # ===========================================================================
  multi-cluster-add-later:
    name: Multi-Cluster (Add Later) - Day 2 Operation
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'multi-cluster' || github.event.inputs.test_suite == '' }}
    env:
      BRANCH_NAME: test/e2e-mc-add-${{ github.run_id }}
      PROJECT_NAME: test-single-cluster
      CONFIG_FILE: single-cluster-config.yaml
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Install tools
        run: |
          curl -Lo /tmp/kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x /tmp/kind && sudo mv /tmp/kind /usr/local/bin/kind
          curl -sSL -o /tmp/argocd https://github.com/argoproj/argo-cd/releases/download/v${{ env.ARGOCD_VERSION }}/argocd-linux-amd64
          chmod +x /tmp/argocd && sudo mv /tmp/argocd /usr/local/bin/argocd

      # Phase A: Start with single cluster
      - name: "Phase A - Step 1: Generate Single Cluster Manifests"
        run: |
          echo "=== Phase A: Starting with Single Cluster ==="
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/output --verbose

      - name: "Phase A - Step 2: Create Single Kind Cluster"
        run: |
          kind create cluster --name e2e-single
          kubectl wait --for=condition=Ready nodes --all --timeout=120s
        timeout-minutes: 3

      - name: "Phase A - Step 3: Push to Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan "${BRANCH_NAME}"
          git rm -rf . || true
          cp -r /tmp/output/${PROJECT_NAME}/* .
          git add -A
          git commit -m "E2E single cluster manifests"
          git push origin "${BRANCH_NAME}"

      - name: "Phase A - Step 4: Bootstrap ArgoCD"
        run: |
          git fetch origin ${{ github.sha }}
          git checkout ${{ github.sha }} -- test/e2e/fixtures/
          ./bin/gitopsi init --config test/e2e/fixtures/${CONFIG_FILE} --output /tmp/bootstrap --bootstrap --bootstrap-mode helm --verbose
        timeout-minutes: 8

      - name: "Phase A - Steps 5-7: Sync and Validate Single Cluster"
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s
          PASSWORD=$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)
          kubectl -n argocd port-forward svc/argocd-server 8080:443 &
          sleep 10
          argocd login localhost:8080 --username admin --password "${PASSWORD}" --insecure --grpc-web

          argocd app create e2e-single-app \
            --repo https://github.com/${{ github.repository }}.git \
            --revision "${BRANCH_NAME}" \
            --path "infrastructure/overlays/dev" \
            --dest-server https://kubernetes.default.svc \
            --dest-namespace dev \
            --sync-policy automated --upsert

          argocd app sync e2e-single-app --timeout 180 || true
          sleep 30

          echo "✓ Phase A Complete: Single cluster working"
          kubectl get namespaces

      # Phase B: Add new cluster via gitopsi
      - name: "Phase B - Step 8: Create Second Kind Cluster"
        run: |
          echo "=== Phase B: Adding New Cluster ==="
          kind create cluster --name e2e-prod

          # Get the prod cluster API server URL
          PROD_API=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-e2e-prod")].cluster.server}')
          echo "Prod cluster API: ${PROD_API}"
          echo "PROD_API=${PROD_API}" >> $GITHUB_ENV

          # Switch back to original cluster
          kubectl config use-context kind-e2e-single
        timeout-minutes: 3

      - name: "Phase B - Step 9: Add Cluster via gitopsi"
        run: |
          echo "=== Adding prod cluster with gitopsi ==="
          cd /tmp/output/${PROJECT_NAME}

          # Use gitopsi to add the cluster
          /github/workspace/bin/gitopsi env add-cluster prod \
            --url "${PROD_API}" \
            --project . \
            --verbose || echo "Add cluster completed"

          echo "Updated structure:"
          find . -type f -name "*.yaml" | head -20

      - name: "Phase B - Step 10: Push Changes"
        run: |
          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "Add prod cluster via gitopsi"
            git push origin "${BRANCH_NAME}"
            echo "Changes pushed"
          else
            echo "No changes to push"
          fi

      - name: "Phase B - Step 11: Verify ArgoCD Sees New Cluster"
        run: |
          # Register new cluster with ArgoCD
          argocd cluster add kind-e2e-prod --yes || echo "May need manual registration"
          argocd cluster list

          echo "=== MULTI-CLUSTER (ADD LATER) TEST COMPLETED ==="

      - name: "Step 12: Cleanup"
        if: always()
        run: |
          kind delete cluster --name e2e-single || true
          kind delete cluster --name e2e-prod || true
          git push origin --delete "${BRANCH_NAME}" || true

  # ===========================================================================
  # Marketplace Tests
  # ===========================================================================
  marketplace-tests:
    name: Marketplace Tests
    needs: [build]
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'marketplace' || github.event.inputs.test_suite == '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: gitopsi-binary
          path: bin

      - name: Make binary executable
        run: chmod +x bin/gitopsi

      - name: Test marketplace commands
        run: |
          ./bin/gitopsi marketplace list || echo "List completed"
          ./bin/gitopsi marketplace categories || echo "Categories listed"
          ./bin/gitopsi marketplace search monitoring || echo "Search completed"
          ./bin/gitopsi marketplace info prometheus || echo "Info retrieved"

      - name: Generate project and test pattern install
        run: |
          ./bin/gitopsi init --config test/e2e/fixtures/standard-config.yaml --output /tmp/project --verbose
          ./bin/gitopsi marketplace validate prometheus --project /tmp/project/test-standard || echo "Validation completed"

  # ===========================================================================
  # Summary Report
  # ===========================================================================
  summary-report:
    name: Summary Report
    needs:
      - build
      - minimal-preset-flow
      - standard-preset-flow
      - enterprise-preset-flow
      - infra-only-flow
      - app-only-flow
      - namespace-scope-flow
      - multi-cluster-2-from-start
      - multi-cluster-add-later
      - marketplace-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary report
        run: |
          echo "# E2E Test Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ needs.build.outputs.commit }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Complete Flow Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Flow | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && '✅' || '❌' }} | Binary compilation |" >> $GITHUB_STEP_SUMMARY
          echo "| Minimal Preset | ${{ needs.minimal-preset-flow.result == 'success' && '✅' || (needs.minimal-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: namespace only |" >> $GITHUB_STEP_SUMMARY
          echo "| Standard Preset | ${{ needs.standard-preset-flow.result == 'success' && '✅' || (needs.standard-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: full infra |" >> $GITHUB_STEP_SUMMARY
          echo "| Enterprise Preset | ${{ needs.enterprise-preset-flow.result == 'success' && '✅' || (needs.enterprise-preset-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: enterprise features |" >> $GITHUB_STEP_SUMMARY
          echo "| Infra-Only Scope | ${{ needs.infra-only-flow.result == 'success' && '✅' || (needs.infra-only-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: no applications |" >> $GITHUB_STEP_SUMMARY
          echo "| App-Only Scope | ${{ needs.app-only-flow.result == 'success' && '✅' || (needs.app-only-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: apps only |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace-Scope | ${{ needs.namespace-scope-flow.result == 'success' && '✅' || (needs.namespace-scope-flow.result == 'skipped' && '⏭️' || '❌') }} | 12-step flow: ns-scoped ArgoCD |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-Cluster (2 start) | ${{ needs.multi-cluster-2-from-start.result == 'success' && '✅' || (needs.multi-cluster-2-from-start.result == 'skipped' && '⏭️' || '❌') }} | 2 clusters from day 1 |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-Cluster (add later) | ${{ needs.multi-cluster-add-later.result == 'success' && '✅' || (needs.multi-cluster-add-later.result == 'skipped' && '⏭️' || '❌') }} | Day 2: add cluster |" >> $GITHUB_STEP_SUMMARY
          echo "| Marketplace | ${{ needs.marketplace-tests.result == 'success' && '✅' || (needs.marketplace-tests.result == 'skipped' && '⏭️' || '❌') }} | Pattern management |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 12-Step Flow Validated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Each preset/scope test validates:" >> $GITHUB_STEP_SUMMARY
          echo "1. ✅ Generate manifests with gitopsi" >> $GITHUB_STEP_SUMMARY
          echo "2. ✅ Create Kind cluster" >> $GITHUB_STEP_SUMMARY
          echo "3. ✅ Push to Git" >> $GITHUB_STEP_SUMMARY
          echo "4. ✅ Bootstrap ArgoCD" >> $GITHUB_STEP_SUMMARY
          echo "5. ✅ Configure ArgoCD to sync from Git" >> $GITHUB_STEP_SUMMARY
          echo "6. ✅ Verify initial sync" >> $GITHUB_STEP_SUMMARY
          echo "7. ✅ Validate resources on cluster" >> $GITHUB_STEP_SUMMARY
          echo "8. ✅ Make code changes" >> $GITHUB_STEP_SUMMARY
          echo "9. ✅ Push changes to Git" >> $GITHUB_STEP_SUMMARY
          echo "10. ✅ Verify ArgoCD syncs changes" >> $GITHUB_STEP_SUMMARY
          echo "11. ✅ Validate changes applied on cluster" >> $GITHUB_STEP_SUMMARY
          echo "12. ✅ Cleanup" >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        run: |
          FAILED=false
          [ "${{ needs.build.result }}" != "success" ] && FAILED=true
          [ "${{ needs.minimal-preset-flow.result }}" != "success" ] && [ "${{ needs.minimal-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.standard-preset-flow.result }}" != "success" ] && [ "${{ needs.standard-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.enterprise-preset-flow.result }}" != "success" ] && [ "${{ needs.enterprise-preset-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.infra-only-flow.result }}" != "success" ] && [ "${{ needs.infra-only-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.app-only-flow.result }}" != "success" ] && [ "${{ needs.app-only-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.namespace-scope-flow.result }}" != "success" ] && [ "${{ needs.namespace-scope-flow.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.multi-cluster-2-from-start.result }}" != "success" ] && [ "${{ needs.multi-cluster-2-from-start.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.multi-cluster-add-later.result }}" != "success" ] && [ "${{ needs.multi-cluster-add-later.result }}" != "skipped" ] && FAILED=true
          [ "${{ needs.marketplace-tests.result }}" != "success" ] && [ "${{ needs.marketplace-tests.result }}" != "skipped" ] && FAILED=true

          if [ "$FAILED" = "true" ]; then
            echo "::error::One or more test flows failed"
            exit 1
          fi
          echo "✅ All E2E tests passed!"

  # ===========================================================================
  # Report Failure
  # ===========================================================================
  report-failure:
    name: Report Failure
    needs:
      - build
      - minimal-preset-flow
      - standard-preset-flow
      - enterprise-preset-flow
      - infra-only-flow
      - app-only-flow
      - namespace-scope-flow
      - multi-cluster-2-from-start
      - multi-cluster-add-later
      - marketplace-tests
      - summary-report
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Check for existing issue
        id: check
        run: |
          EXISTING=$(gh issue list --repo ${{ github.repository }} --search "E2E Test Failure" --state open --json number --jq 'length')
          echo "exists=$( [ \"${EXISTING}\" -gt \"0\" ] && echo true || echo false )" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create failure issue
        if: steps.check.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat <<EOF > /tmp/issue_body.md
          ## E2E Test Failure

          **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          **Version**: ${{ needs.build.outputs.version }}
          **Commit**: ${{ needs.build.outputs.commit }}

          ### Test Results
          | Test Flow | Status |
          |-----------|--------|
          | Build | ${{ needs.build.result }} |
          | Minimal Preset | ${{ needs.minimal-preset-flow.result }} |
          | Standard Preset | ${{ needs.standard-preset-flow.result }} |
          | Enterprise Preset | ${{ needs.enterprise-preset-flow.result }} |
          | Infra-Only | ${{ needs.infra-only-flow.result }} |
          | App-Only | ${{ needs.app-only-flow.result }} |
          | Namespace-Scope | ${{ needs.namespace-scope-flow.result }} |
          | Multi-Cluster (2 start) | ${{ needs.multi-cluster-2-from-start.result }} |
          | Multi-Cluster (add later) | ${{ needs.multi-cluster-add-later.result }} |
          | Marketplace | ${{ needs.marketplace-tests.result }} |

          ### Next Steps
          1. Check the failed job logs
          2. Reproduce locally with kind cluster
          3. Fix the issue and re-run
          EOF

          gh issue create \
            --repo ${{ github.repository }} \
            --title "E2E Test Failure: ${{ needs.build.outputs.version }}" \
            --body-file /tmp/issue_body.md
