# gitopsi Manual Test Guide

## Product Owner Validation Test

This guide allows you to test gitopsi's full functionality with **zero manual kubectl/oc commands**.

---

## Prerequisites

1. **Podman Desktop** - Running and configured
2. **Kind** - For local Kubernetes cluster

### Quick Check

```bash
# Verify Podman is running
podman info | head -5

# Verify Kind is available
which kind || brew install kind
```

---

## Test Configuration

The test uses:
- **Git Repository**: `https://github.com/ihsanmokhlisse/gitopsitest`
- **Local Kubernetes**: Kind cluster
- **GitOps Tool**: ArgoCD (installed by gitopsi)

---

## Step-by-Step Test

### Step 1: Prepare Environment

```bash
cd /Users/imokhlis/Projects/generator-gitops

# Ensure binary is executable
chmod +x bin/gitopsi

# Verify gitopsi works
./bin/gitopsi version
```

### Step 2: Create Local Kubernetes Cluster

```bash
# Delete any existing test cluster
kind delete cluster --name gitopsi-test 2>/dev/null

# Create fresh Kind cluster
kind create cluster --name gitopsi-test --wait 5m

# Verify cluster is ready
kubectl cluster-info --context kind-gitopsi-test
```

### Step 3: Set Environment Variables

```bash
# GitHub Personal Access Token (with repo scope)
# Generate at: https://github.com/settings/tokens
export GITOPSI_GIT_TOKEN="your-github-token-here"

# Get cluster API URL (automatic)
export GITOPSI_CLUSTER_URL="https://127.0.0.1:$(docker port gitopsi-test-control-plane 6443 | cut -d: -f2)"

# No cluster token needed for Kind (uses kubeconfig)
```

### Step 4: Create Test Configuration

```bash
cat > /tmp/gitopsi-product-test.yaml << 'EOF'
project:
  name: gitopsi-product-test
  description: "Product Owner Validation Test"

platform: kubernetes
scope: both
gitops_tool: argocd

git:
  url: https://github.com/ihsanmokhlisse/gitopsitest
  branch: main
  push_on_init: true

environments:
  - name: dev
    namespace: product-test-dev
  - name: staging
    namespace: product-test-staging

applications:
  - name: nginx
    type: deployment
    replicas: 2
    image: nginxinc/nginx-unprivileged:1.25-alpine
    port: 8080

infrastructure:
  namespaces: true
  rbac: true
  network_policies: true
  resource_quotas: true

bootstrap:
  enabled: true
  mode: helm
  namespace: argocd
  wait: true
  timeout: 300
  configure_repo: true
  create_app_of_apps: true
EOF
```

### Step 5: Run gitopsi (Single Command!)

```bash
./bin/gitopsi init \
  --config /tmp/gitopsi-product-test.yaml \
  --bootstrap \
  --verbose
```

**What this does automatically:**
1. âœ… Generates GitOps repository structure
2. âœ… Pushes code to GitHub (gitopsitest repo)
3. âœ… Installs ArgoCD on the Kind cluster
4. âœ… Configures ArgoCD to sync from GitHub
5. âœ… Creates applications in ArgoCD
6. âœ… Displays ArgoCD URL and credentials

---

## Expected Output

```
ðŸš€ Starting gitopsi initialization...

ðŸ“‹ Configuration:
   Project: gitopsi-product-test
   Platform: kubernetes
   GitOps Tool: argocd
   Environments: dev, staging

ðŸ”„ Generating GitOps repository structure...
   âœ… Infrastructure manifests generated
   âœ… Application manifests generated
   âœ… ArgoCD configuration generated

ðŸ“¤ Pushing to Git repository...
   Repository: https://github.com/ihsanmokhlisse/gitopsitest
   âœ… Code pushed successfully

ðŸ”§ Bootstrapping ArgoCD...
   Installing ArgoCD via Helm...
   âœ… ArgoCD installed
   Waiting for ArgoCD to be ready...
   âœ… ArgoCD is running

ðŸ”— Configuring ArgoCD...
   âœ… Repository configured
   âœ… Applications created

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    SETUP COMPLETE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸŒ ArgoCD UI: https://localhost:PORT
ðŸ‘¤ Username: admin
ðŸ”‘ Password: <auto-generated>

ðŸ“‚ Generated files: ./gitopsi-product-test/
ðŸ“¦ Git repository: https://github.com/ihsanmokhlisse/gitopsitest

Your GitOps environment is ready!
```

---

## Validation Checklist

After running gitopsi, verify these manually:

### 1. Check Generated Files

```bash
ls -la gitopsi-product-test/
```

Expected structure:
```
gitopsi-product-test/
â”œâ”€â”€ README.md
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ base/
â”‚   â”‚   â”œâ”€â”€ kustomization.yaml
â”‚   â”‚   â”œâ”€â”€ namespaces/
â”‚   â”‚   â”œâ”€â”€ rbac/
â”‚   â”‚   â”œâ”€â”€ network-policies/
â”‚   â”‚   â””â”€â”€ resource-quotas/
â”‚   â””â”€â”€ overlays/
â”‚       â”œâ”€â”€ dev/
â”‚       â””â”€â”€ staging/
â”œâ”€â”€ applications/
â”‚   â””â”€â”€ base/
â”‚       â””â”€â”€ nginx/
â”œâ”€â”€ argocd/
â”‚   â”œâ”€â”€ projects/
â”‚   â”œâ”€â”€ applications/
â”‚   â””â”€â”€ applicationsets/
â””â”€â”€ scripts/
    â””â”€â”€ bootstrap.sh
```

### 2. Check GitHub Repository

Open: https://github.com/ihsanmokhlisse/gitopsitest

- âœ… Files should be pushed
- âœ… Structure matches local generation

### 3. Access ArgoCD UI

The output will show the ArgoCD URL and password.

```bash
# Get ArgoCD URL (if not shown)
kubectl get svc -n argocd argocd-server

# Get ArgoCD password
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
```

### 4. Verify in ArgoCD UI

1. Open ArgoCD URL in browser
2. Login with `admin` / password from output
3. Check:
   - âœ… `gitopsi-product-test` project exists
   - âœ… Applications are listed (infrastructure, nginx)
   - âœ… Sync status shows "Synced" or "OutOfSync â†’ Synced"
   - âœ… Health status shows "Healthy"

---

## Cleanup

```bash
# Delete the Kind cluster
kind delete cluster --name gitopsi-test

# Remove generated files
rm -rf gitopsi-product-test/
rm -f /tmp/gitopsi-product-test.yaml
```

---

## Troubleshooting

### "invalid GitHub token"

Generate a new token at https://github.com/settings/tokens with `repo` scope.

### "ArgoCD not ready"

Check ArgoCD pods:
```bash
kubectl get pods -n argocd
```

### "Push failed"

Verify git token has write access to `gitopsitest` repository.

---

## Test Scenarios

### Scenario A: Generate Only (No Push/Bootstrap)

```bash
./bin/gitopsi init --config /tmp/gitopsi-product-test.yaml --dry-run
```

### Scenario B: With Validation

```bash
./bin/gitopsi init --config /tmp/gitopsi-product-test.yaml --validate
```

### Scenario C: Using Presets

```bash
./bin/gitopsi init --preset minimal --output /tmp/minimal-test
./bin/gitopsi init --preset standard --output /tmp/standard-test
./bin/gitopsi init --preset enterprise --output /tmp/enterprise-test
```

---

## Success Criteria

| Check | Expected Result |
|-------|-----------------|
| `gitopsi init` completes | Exit code 0 |
| Files generated | Structure matches spec |
| Git push successful | Files visible on GitHub |
| ArgoCD installed | Pods running in argocd namespace |
| ArgoCD configured | Repository and apps visible in UI |
| Applications sync | Status shows "Synced" |

---

**Test completed successfully when all checks pass with a single `gitopsi init` command!**
